<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Intro to AWS SageMaker for Predictive ML/AI: RAG with a Notebook GPU</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicons/incubator/favicon-16x16.png"><link rel="manifest" href="favicons/incubator/site.webmanifest"><link rel="mask-icon" href="favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Learn how to run predictive AI/ML procedures (train, tune, etc.) using AWS SageMaker. These examples focus on narrow &amp;quot;predictive ML/AI&amp;quot; cases, where models are trained to perform a single function (contrasing with &amp;quot;foundation&amp;quot; model use via AWS Bedrock). These materials are directed towards participants of the 2024 Machine Learning Marathon, and some instructions may pertain only to that group. A more general purpose version of this workshop will be made available in future months." src="assets/images/incubator-logo.svg"><span class="badge text-bg-warning">
          <abbr title="This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback.">
            <a href="https://docs.carpentries.org/resources/curriculum/lesson-life-cycle.html" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-triangle" style="border-radius: 5px"></i>
              Alpha
            </a>
            <span class="visually-hidden">This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>


      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/01_RAG_WattBot_GPU-instance.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Learn how to run predictive AI/ML procedures (train, tune, etc.) using AWS SageMaker. These examples focus on narrow &amp;quot;predictive ML/AI&amp;quot; cases, where models are trained to perform a single function (contrasing with &amp;quot;foundation&amp;quot; model use via AWS Bedrock). These materials are directed towards participants of the 2024 Machine Learning Marathon, and some instructions may pertain only to that group. A more general purpose version of this workshop will be made available in future months." src="assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Intro to AWS SageMaker for Predictive ML/AI
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Intro to AWS SageMaker for Predictive ML/AI
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="reference.html">Glossary</a></li><li><a class="dropdown-item" href="instances-for-ML.html">Instances for ML</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Intro to AWS SageMaker for Predictive ML/AI
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 59%" class="percentage">
    59%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 59%" aria-valuenow="59" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/01_RAG_WattBot_GPU-instance.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="SageMaker-overview.html">1. Overview of Amazon SageMaker</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="Data-storage-setting-up-S3.html">2. Data Storage: Setting up S3</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="SageMaker-notebooks-as-controllers.html">3. Notebooks as Controllers</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="Accessing-S3-via-SageMaker-notebooks.html">4. Accessing and Managing Data in S3 with SageMaker Notebooks</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="Interacting-with-code-repo.html">5. Using a GitHub Personal Access Token (PAT) to Push/Pull from a SageMaker Notebook</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="Training-models-in-SageMaker-notebooks.html">6. Training Models in SageMaker: Intro</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="Training-models-in-SageMaker-notebooks-part2.html">7. Training Models in SageMaker: PyTorch Example</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="Hyperparameter-tuning.html">8. Hyperparameter Tuning in SageMaker: Neural Network Example</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="00_Overview-RAG-on-AWS.html">9. Overview of RAG Workflows on AWS</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        10. RAG with a Notebook GPU
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#working-with-aws-for-rag-experiments">Working with AWS for RAG Experiments</a></li>
<li><a href="#overview-wattbot-rag-on-a-single-notebook-gpu">Overview: WattBot RAG on a single notebook GPU</a></li>
<li><a href="#notebook-dataset-setup">Notebook + dataset setup</a></li>
<li><a href="#import-data-from-bucket-into-notebook">Import data from bucket into notebook</a></li>
<li><a href="#step-1-imports-paths-and-safe-csv-loading">Step 1 – Imports, paths, and safe CSV loading</a></li>
<li><a href="#step-2-download-all-pdfs-from-metadata.csv">Step 2 – Download all PDFs from <code>metadata.csv</code></a></li>
<li><a href="#step-3-turn-pdfs-into-page-level-documents">Step 3 – Turn PDFs into page-level “documents”</a></li>
<li><a href="#step-4-simple-explicit-text-chunking">Step 4 – Simple, explicit text chunking</a></li>
<li><a href="#step-5-build-an-embedding-matrix">Step 5 – Build an embedding matrix</a></li>
<li><a href="#recap-and-next-steps">Recap and next steps</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="02_RAG_WattBot_Processing_Jobs.html">11. RAG with Processing Jobs</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush13">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading13">
        <a href="03_RAG_WattBot_Bedrock.html">12. RAG with Bedrock</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush14">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading14">
        <a href="Resource-management-cleanup.html">13. Resource Management and Monitoring</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Glossary</a></li><li><a href="instances-for-ML.html">Instances for ML</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="00_Overview-RAG-on-AWS.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="02_RAG_WattBot_Processing_Jobs.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="00_Overview-RAG-on-AWS.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Overview of RAG
        </a>
        <a class="chapter-link float-end" href="02_RAG_WattBot_Processing_Jobs.html" rel="next">
          Next: RAG with Processing...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>RAG with a Notebook GPU</h1>
        <p>Last updated on 2025-12-19 |

        <a href="https://github.com/UW-Madison-DataScience/ml-with-aws-sagemaker/edit/main/episodes/01_RAG_WattBot_GPU-instance.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How can we run a basic Retrieval-Augmented Generation (RAG) pipeline
entirely from a single GPU-backed SageMaker notebook?</li>
<li>How do we go from raw PDFs and CSV files to a searchable embedding
space for WattBot documents?</li>
<li>How can we generate WattBot-style answers (including citations and
evidence) that follow the competition’s scoring conventions?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Verify that our SageMaker notebook instance has a working GPU and
compatible Python environment.</li>
<li>Load the WattBot metadata and question–answer files from local
storage and inspect their structure.</li>
<li>Download all referenced PDFs from <code>metadata.csv</code> and turn
them into a collection of text pages with useful metadata attached.</li>
<li>Implement a simple, explicit “from scratch” text-chunking and
embedding pipeline without relying on FAISS or production vector
DBs.</li>
<li>Build a small retrieval helper that finds the most relevant chunks
for a question using cosine similarity in embedding space.</li>
<li>Wire the retriever to a local Qwen 7B-style generator to produce
WattBot-format answers (including <code>answer</code>,
<code>ref_id</code>, <code>ref_url</code>, and
<code>supporting_materials</code>).</li>
<li>Add a second LLM pass that generates short explanations and marks
whether the evidence comes from text, figures, tables, or a
combination.</li>
</ul></div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="working-with-aws-for-rag-experiments">Working with AWS for RAG Experiments<a class="anchor" aria-label="anchor" href="#working-with-aws-for-rag-experiments"></a></h2>
<hr class="half-width"><p>In the previous episode, we briefly introduced several approaches for
implementing RAG in AWS. Here, we are simply selecting a good GPU
instance that can handle whatever RAG system we want to build. This
approach is:</p>
<ul><li>Very easy to understand core on the AWS side of things (just select
GPU instance and you’re good to move on)</li>
<li>Ideal for learning retrieval and generation steps<br></li>
<li>Great for experimentation and debugging</li>
</ul><p>However, it is <strong>not the most cost‑efficient method</strong>.
In upcoming episodes we will introduce more efficient and
production‑aligned GPU strategies, including:</p>
<ul><li>On-demand GPU tasks<br></li>
<li>Fully managed asynchronous jobs<br></li>
<li>Serverless or streaming LLM inference<br></li>
<li>SageMaker batch transform &amp; RAG pipelines<br></li>
<li>Embedding jobs that run only when needed</li>
</ul><p>Those techniques bring you closer to best practice for scalable and
budget‑friendly research computing.</p>
<p><strong>Remember to Shut Down Your AWS Instance</strong>: GPU
notebook instances continue billing <strong>even when idle</strong>.
Always:</p>
<ul><li>Save your work<br></li>
<li>Shut down or stop the instance when not in use</li>
<li>Verify the status in the AWS console</li>
</ul><p>This habit prevents accidental ongoing GPU charges.</p>
</section><section><h2 class="section-heading" id="overview-wattbot-rag-on-a-single-notebook-gpu">Overview: WattBot RAG on a single notebook GPU<a class="anchor" aria-label="anchor" href="#overview-wattbot-rag-on-a-single-notebook-gpu"></a></h2>
<hr class="half-width"><p>In this episode we build a <strong>minimal but realistic RAG
pipeline</strong> from the <a href="https://www.kaggle.com/competitions/WattBot2025/overview" class="external-link">WattBot
2025</a> challenge that runs entirely from a single GPU-backed SageMaker
notebook.</p>
<p>In this episode we will:</p>
<ol style="list-style-type: decimal"><li>
<strong>Work directly with the WattBot data.</strong>
<ul><li>Use <code>train_QA.csv</code> and <code>metadata.csv</code> from the
competition dataset.</li>
<li>Download all referenced PDFs (our RAG corpus) using the URLs in
<code>metadata.csv</code>.</li>
</ul></li>
<li>
<strong>Implement the core RAG steps explicitly in code.</strong>
<ul><li>Read PDFs, extract per-page text, and attach document metadata.</li>
<li>Chunk text into overlapping segments suitable for embedding.</li>
<li>Embed chunks with a sentence-transformer
(<code>thenlper/gte-base</code>)</li>
<li>Implement cosine-similarity search over the embedding matrix.</li>
</ul></li>
<li>
<strong>Connect to a local Qwen-style generator.</strong>
<ul><li>Use a quantized 7B model on a GPU-backed instance (e.g.,
<code>ml.g5.xlarge</code>).</li>
<li>Construct WattBot-style answers that we can compare against
<code>train_QA.csv</code>.</li>
</ul></li>
<li>
<strong>Add an explanation pass.</strong>
<ul><li>Use an LLM to look at the retrieved evidence, the answer, and
citations.</li>
<li>Generate a short explanation and label the <strong>evidence
type</strong>: <code>[Quote]</code>, <code>[Table]</code>,
<code>[Figure]</code>, or <code>[Mixed]</code>.</li>
</ul></li>
</ol></section><section><h2 class="section-heading" id="notebook-dataset-setup">Notebook + dataset setup<a class="anchor" aria-label="anchor" href="#notebook-dataset-setup"></a></h2>
<hr class="half-width"><p>For this episode, we assume you are running on an AWS SageMaker
notebook instance with a GPU, such as:</p>
<ul><li>
<code>ml.g5.xlarge</code> (recommended) or</li>
<li>
<code>ml.g4dn.xlarge</code> (may work with smaller models / more
aggressive quantization).</li>
</ul><p>See <a href="https://carpentries-incubator.github.io/ML_with_AWS_SageMaker/instances-for-ML.html" class="external-link">Instances
for ML</a> for further guidance.</p>
<div class="section level3">
<h3 id="step-1-download-data-zip-locally">Step 1 – Download <code>data.zip</code> locally<a class="anchor" aria-label="anchor" href="#step-1-download-data-zip-locally"></a></h3>
<p>We’ll use the <strong>WattBot 2025</strong> dataset. Download the
workshop data archive to your laptop or desktop:</p>
<ul><li>Open this link in your browser: <a href="https://github.com/carpentries-incubator/ML_with_AWS_SageMaker/blob/main/data/data.zip" class="external-link uri">https://github.com/carpentries-incubator/ML_with_AWS_SageMaker/blob/main/data/data.zip</a>
</li>
<li>Save <code>data.zip</code> somewhere you can find it easily and
unzip the folder contents</li>
</ul><p>This archive should include a <code>data/wattbot/</code> folder
containing:</p>
<ul><li>
<code>metadata.csv</code> – index of all WattBot papers.</li>
<li>
<code>train_QA.csv</code> – labeled questions + ground truth
answers.</li>
</ul></div>
<div class="section level3">
<h3 id="step-2-create-a-wattbot-s3-bucket">Step 2 – Create a WattBot S3 bucket<a class="anchor" aria-label="anchor" href="#step-2-create-a-wattbot-s3-bucket"></a></h3>
<p>In the AWS console:</p>
<ol style="list-style-type: decimal"><li>Go to <strong>S3</strong>.</li>
<li>Create a new bucket named something like:<br><code>teamname-yourname-wattbot</code>
</li>
<li>Keep <strong>Block all public access</strong> enabled.</li>
<li>Add tags so we can track costs:
<ul><li>
<code>Project = your-team-name</code><br></li>
<li>
<code>Name = your-name</code><br></li>
<li><code>Purpose = RAG-demo</code></li>
</ul></li>
<li>Once the bucket is created, you’ll be brought to a page that shows
all of your current buckets (and those on our shared account). We’ll
have to edit our bucket’s policy to allow ourselves proper access to any
files stored there (e.g., read from bucket, write to bucket). To set
these permissions…</li>
</ol><ol style="list-style-type: lower-alpha"><li>Click on the name of your bucket to bring up additional options and
settings.
<ol start="2" style="list-style-type: lower-alpha"><li>Click the Permissions tab</li>
<li>Scroll down to Bucket policy and click Edit. Paste the following
policy, editing the bucket name “sinkorswim-doejohn-wattbot” to reflect
your bucket’s nameAs we did in the “setting up S3 episode, edit your
bucket’s policy to include the following:</li>
</ol></li>
</ol><div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JSON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode json" tabindex="0"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>	<span class="dt">"Version"</span><span class="fu">:</span> <span class="st">"2012-10-17"</span><span class="fu">,</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>	<span class="dt">"Statement"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>		<span class="fu">{</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>			<span class="dt">"Effect"</span><span class="fu">:</span> <span class="st">"Allow"</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>			<span class="dt">"Principal"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>			    <span class="dt">"AWS"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>			        <span class="st">"arn:aws:iam::183295408236:role/ml-sagemaker-use"</span><span class="ot">,</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>			        <span class="st">"arn:aws:iam::183295408236:role/ml-sagemaker-bedrock-use"</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>		        <span class="ot">]</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>			<span class="fu">},</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>			<span class="dt">"Action"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>				<span class="st">"s3:GetObject"</span><span class="ot">,</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>				<span class="st">"s3:PutObject"</span><span class="ot">,</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>				<span class="st">"s3:DeleteObject"</span><span class="ot">,</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>				<span class="st">"s3:ListMultipartUploadParts"</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>			<span class="ot">]</span><span class="fu">,</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>			<span class="dt">"Resource"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>				<span class="st">"arn:aws:s3:::sinkorswim-chrisendemann-titanic"</span><span class="ot">,</span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>				<span class="st">"arn:aws:s3:::sinkorswim-chrisendemann-titanic/*"</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>			<span class="ot">]</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>		<span class="fu">}</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>	<span class="ot">]</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="fu">}</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="step-3-upload-the-wattbot-files-to-s3">Step 3 – Upload the WattBot files to S3<a class="anchor" aria-label="anchor" href="#step-3-upload-the-wattbot-files-to-s3"></a></h3>
<ol style="list-style-type: decimal"><li><p>In your new bucket, click <strong>Upload</strong>.</p></li>
<li><p>Drag the <code>data/wattbot/</code> folder contents from
<code>data.zip</code> into the upload dialog.</p></li>
<li>
<p>Upload it so that your bucket contains paths like:</p>
<ul><li><code>metadata.csv</code></li>
<li><code>train_QA.csv</code></li>
</ul></li>
</ol><p>We’ll pull these files from S3 into the notebook in the next
steps.</p>
</div>
<div class="section level3">
<h3 id="verify-gpu-and-basic-environment">Verify GPU and basic environment<a class="anchor" aria-label="anchor" href="#verify-gpu-and-basic-environment"></a></h3>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="op">!</span>nvidia<span class="op">-</span>smi <span class="op">||</span> echo <span class="st">"No GPU detected – please switch to a GPU-backed instance (e.g., ml.g5.xlarge) before running this notebook."</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># also verify you've selected teh conda_pytorch_p310 kernel</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"torch cuda available:"</span>, torch.cuda.is_available())</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"num gpus:"</span>, torch.cuda.device_count())</span></code></pre>
</div>
</div>
</section><section><h2 class="section-heading" id="import-data-from-bucket-into-notebook">Import data from bucket into notebook<a class="anchor" aria-label="anchor" href="#import-data-from-bucket-into-notebook"></a></h2>
<hr class="half-width"><div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Any</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="im">import</span> sagemaker</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="im">from</span> sagemaker <span class="im">import</span> get_execution_role</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="co"># Initialize SageMaker + AWS basics</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>session <span class="op">=</span> sagemaker.Session()</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>region <span class="op">=</span> session.boto_region_name</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>role <span class="op">=</span> get_execution_role()</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>s3_client <span class="op">=</span> boto3.client(<span class="st">"s3"</span>, region_name<span class="op">=</span>region)</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Region:"</span>, region)</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Role:"</span>, role)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">def</span> download_s3_object(bucket: <span class="bu">str</span>, key: <span class="bu">str</span>, local_path: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    os.makedirs(os.path.dirname(local_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Downloading s3://</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>local_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    s3_client.download_file(bucket, key, local_path)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: update this to your bucket name</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>bucket_name <span class="op">=</span> <span class="st">"chris-rag"</span>  <span class="co"># &lt;-- EDIT ME</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co"># Local working directory in the notebook instance</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>local_data_dir <span class="op">=</span> <span class="st">"./data"</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Local data dir:"</span>, local_data_dir)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Download metadata.csv and train_QA.csv</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>metadata_key <span class="op">=</span> <span class="st">"metadata.csv"</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>train_qa_key <span class="op">=</span> <span class="st">"train_QA.csv"</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>metadata_path <span class="op">=</span> os.path.join(local_data_dir, metadata_key)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>train_qa_path <span class="op">=</span> os.path.join(local_data_dir, train_qa_key)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>download_s3_object(bucket_name, metadata_key, metadata_path)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>download_s3_object(bucket_name, train_qa_key, train_qa_path)</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="step-1-imports-paths-and-safe-csv-loading">Step 1 – Imports, paths, and safe CSV loading<a class="anchor" aria-label="anchor" href="#step-1-imports-paths-and-safe-csv-loading"></a></h2>
<hr class="half-width"><div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Any, Tuple</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForCausalLM, AutoTokenizer</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">def</span> smart_read_csv(path: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    <span class="co">"""Try several encodings when reading a CSV file.</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">    Some CSVs (especially those with special characters in author names or titles)</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">    may not be valid UTF-8. This helper rotates through common encodings and raises</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">    the last error only if all fail.</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>    encodings <span class="op">=</span> [<span class="st">"utf-8"</span>, <span class="st">"latin1"</span>, <span class="st">"ISO-8859-1"</span>, <span class="st">"cp1252"</span>]</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>    last_error <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>    <span class="cf">for</span> enc <span class="kw">in</span> encodings:</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>            <span class="cf">return</span> pd.read_csv(path, encoding<span class="op">=</span>enc)</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>            last_error <span class="op">=</span> e</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>    <span class="cf">if</span> last_error <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>        <span class="cf">raise</span> last_error</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f"Unable to read CSV at </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>train_df <span class="op">=</span> smart_read_csv(train_qa_path)</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>metadata_df <span class="op">=</span> smart_read_csv(metadata_path)</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"train_QA.csv columns:"</span>, train_df.columns.tolist())</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"metadata.csv columns:"</span>, metadata_df.columns.tolist())</span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Number of training QAs:"</span>, <span class="bu">len</span>(train_df))</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of metadata rows:"</span>, <span class="bu">len</span>(metadata_df))</span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>train_df.head(<span class="dv">15</span>)</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="step-2-download-all-pdfs-from-metadata-csv">Step 2 – Download all PDFs from <code>metadata.csv</code>
<a class="anchor" aria-label="anchor" href="#step-2-download-all-pdfs-from-metadata-csv"></a></h2>
<hr class="half-width"><p>Next we will…</p>
<ol style="list-style-type: decimal"><li>Read the <code>url</code> column from
<code>metadata.csv</code>.</li>
<li>Download each PDF via HTTP and save it locally as
<code>&lt;id&gt;.pdf</code> under <code>pdfs/</code>.</li>
<li>Report any failures (e.g., missing or malformed URLs) at the
end.</li>
<li>Upload zipped version of corpus to S3</li>
</ol><div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>PDF_DIR <span class="op">=</span> os.path.join(local_data_dir, <span class="st">"pdfs"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>os.makedirs(PDF_DIR, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="kw">def</span> download_all_pdfs_from_urls(</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>    metadata: pd.DataFrame,</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    local_pdf_dir: <span class="bu">str</span>,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>    url_col: <span class="bu">str</span> <span class="op">=</span> <span class="st">"url"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>    id_col: <span class="bu">str</span> <span class="op">=</span> <span class="st">"id"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    timeout: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="co">"""Download all PDFs referenced in `metadata` using their URLs.</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co">    - Saves each file as `&lt;id&gt;.pdf` in `local_pdf_dir`.</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="co">    - Strips whitespace from the URL (to avoid trailing spaces becoming `%20`).</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="co">    - Skips rows with missing or non-HTTP URLs.</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="co">    - Prints a short summary of any failures.</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>    os.makedirs(local_pdf_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>    errors: List[Tuple[<span class="bu">str</span>, <span class="bu">str</span>]] <span class="op">=</span> []</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saving PDFs to: </span><span class="sc">{</span>local_pdf_dir<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> metadata.iterrows():</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>        doc_id <span class="op">=</span> <span class="bu">str</span>(row[id_col]).strip()</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>        raw_url <span class="op">=</span> row.get(url_col, <span class="va">None</span>)</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(raw_url, <span class="bu">str</span>):</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>            errors.append((doc_id, <span class="st">"URL is not a string"</span>))</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>        pdf_url <span class="op">=</span> raw_url.strip()  <span class="co"># important: strip trailing whitespace</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> pdf_url.startswith(<span class="st">"http"</span>):</span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>            errors.append((doc_id, <span class="ss">f"Invalid URL: </span><span class="sc">{</span>pdf_url<span class="sc">!r}</span><span class="ss">"</span>))</span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>        local_path <span class="op">=</span> os.path.join(local_pdf_dir, <span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Downloading </span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss"> from </span><span class="sc">{</span>pdf_url<span class="sc">}</span><span class="ss"> ..."</span>)</span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a>            resp <span class="op">=</span> requests.get(pdf_url, timeout<span class="op">=</span>timeout, allow_redirects<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a>            resp.raise_for_status()</span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a>            content_type <span class="op">=</span> resp.headers.get(<span class="st">"Content-Type"</span>, <span class="st">""</span>)</span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"pdf"</span> <span class="kw">not</span> <span class="kw">in</span> content_type.lower() <span class="kw">and</span> <span class="kw">not</span> pdf_url.lower().endswith(<span class="st">".pdf"</span>):</span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  Warning: Content-Type for </span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss"> does not look like PDF (</span><span class="sc">{</span>content_type<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(local_path, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a>                f.write(resp.content)</span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  -&gt; FAILED for </span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a>            errors.append((doc_id, <span class="bu">str</span>(e)))</span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a>    <span class="cf">if</span> errors:</span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Some PDFs could not be downloaded:"</span>)</span>
<span id="cb10-57"><a href="#cb10-57" tabindex="-1"></a>        <span class="cf">for</span> doc_id, err <span class="kw">in</span> errors:</span>
<span id="cb10-58"><a href="#cb10-58" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>err<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-59"><a href="#cb10-59" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-60"><a href="#cb10-60" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">All PDFs downloaded successfully!"</span>)</span>
<span id="cb10-61"><a href="#cb10-61" tabindex="-1"></a></span>
<span id="cb10-62"><a href="#cb10-62" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" tabindex="-1"></a>download_all_pdfs_from_urls(</span>
<span id="cb10-64"><a href="#cb10-64" tabindex="-1"></a>    metadata_df,</span>
<span id="cb10-65"><a href="#cb10-65" tabindex="-1"></a>    PDF_DIR,</span>
<span id="cb10-66"><a href="#cb10-66" tabindex="-1"></a>    url_col<span class="op">=</span><span class="st">"url"</span>,</span>
<span id="cb10-67"><a href="#cb10-67" tabindex="-1"></a>    id_col<span class="op">=</span><span class="st">"id"</span>,</span>
<span id="cb10-68"><a href="#cb10-68" tabindex="-1"></a>    timeout<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb10-69"><a href="#cb10-69" tabindex="-1"></a>)</span>
<span id="cb10-70"><a href="#cb10-70" tabindex="-1"></a></span>
<span id="cb10-71"><a href="#cb10-71" tabindex="-1"></a><span class="bu">len</span>(os.listdir(PDF_DIR))</span></code></pre>
</div>
<div class="section level3">
<h3 id="zip-all-pdfs-and-upload-to-s3">Zip all PDFs and upload to S3<a class="anchor" aria-label="anchor" href="#zip-all-pdfs-and-upload-to-s3"></a></h3>
<p>Once we have all PDFs locally, it can be convenient and efficient
to:</p>
<ol style="list-style-type: decimal"><li>Zip them into a single file (e.g.,
<code>wattbot_pdfs.zip</code>).<br></li>
<li>Upload that ZIP archive to an S3 bucket, such as
<code>s3://&lt;your-wattbot-bucket&gt;/data/wattbot/wattbot_pdfs.zip</code>.</li>
</ol><p>We’ll include a short code example here, but feel free to skip this
during the workshop if time is tight.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="kw">def</span> zip_and_upload_pdfs(</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    local_pdf_dir: <span class="bu">str</span>,</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    bucket: <span class="bu">str</span>,</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    zip_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">"corpus.zip"</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">    Zips all PDFs in local_pdf_dir and uploads the ZIP file to:</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">        s3://&lt;bucket&gt;/&lt;prefix&gt;/&lt;zip_name&gt;</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co">    Returns the full S3 URI of the uploaded zip file.</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>    <span class="co"># Ensure directory exists</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(local_pdf_dir):</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Directory not found: </span><span class="sc">{</span>local_pdf_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    <span class="co"># Path for the ZIP file</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>    zip_path <span class="op">=</span> os.path.join(local_pdf_dir, zip_name)</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>    <span class="co"># Create ZIP archive</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>    <span class="cf">with</span> zipfile.ZipFile(zip_path, <span class="st">"w"</span>, zipfile.ZIP_DEFLATED) <span class="im">as</span> zipf:</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>        <span class="cf">for</span> fname <span class="kw">in</span> os.listdir(local_pdf_dir):</span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>            <span class="cf">if</span> fname.lower().endswith(<span class="st">".pdf"</span>):</span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>                fpath <span class="op">=</span> os.path.join(local_pdf_dir, fname)</span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>                zipf.write(fpath, arcname<span class="op">=</span>fname)</span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Added to ZIP: </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">ZIP created: </span><span class="sc">{</span>zip_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>    <span class="co"># Upload to S3</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>    s3_client <span class="op">=</span> boto3.client(<span class="st">"s3"</span>)</span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>    s3_key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>zip_name<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Uploading to s3://</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>s3_key<span class="sc">}</span><span class="ss"> ..."</span>)</span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a>    s3_client.upload_file(zip_path, bucket, s3_key)</span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Upload complete."</span>)</span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a></span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"s3://</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>s3_key<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a>zip_s3_uri <span class="op">=</span> zip_and_upload_pdfs(</span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a>    local_pdf_dir<span class="op">=</span>PDF_DIR,</span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a>    bucket<span class="op">=</span>bucket_name</span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a>)</span></code></pre>
</div>
</div>
</section><section><h2 class="section-heading" id="step-3-turn-pdfs-into-page-level-documents">Step 3 – Turn PDFs into page-level “documents”<a class="anchor" aria-label="anchor" href="#step-3-turn-pdfs-into-page-level-documents"></a></h2>
<hr class="half-width"><p>Next, we convert each PDF into a list of <strong>page-level
records</strong>. Each record stores:</p>
<ul><li>
<code>text</code>: page text (as extracted by
<code>pypdf</code>).</li>
<li>
<code>doc_id</code>: short ID from <code>metadata.csv</code> (e.g.,
<code>strubell2019</code>).</li>
<li>
<code>title</code>: title of the document.</li>
<li>
<code>url</code>: original PDF URL.</li>
<li>
<code>page_num</code>: zero-based page index.</li>
<li>
<code>page_label</code>: label used inside the PDF (often
1-based).</li>
</ul><p>Later, we will <strong>chunk these pages</strong> into smaller
overlapping segments for embedding.</p>
<div class="section level3">
<h3 id="why-we-page-chunk-first">Why we page-chunk first<a class="anchor" aria-label="anchor" href="#why-we-page-chunk-first"></a></h3>
<p>We split the PDF into <strong>pages before chunking</strong> because
pages give us a stable, easy-to-interpret unit.<br>
This helps with:</p>
<ul><li>
<strong>Keeping metadata</strong> (doc ID, URL, page labels) tied to
the text.<br></li>
<li>
<strong>Debugging retrieval</strong> — it’s much easier to
understand what the model saw if we know which page(s) were used.<br></li>
<li>
<strong>Cleaning text</strong> before making smaller overlapping
chunks.<br></li>
<li>
<strong>Flexibility later</strong> — once pages are structured, we
can try different chunk sizes or strategies without re-extracting the
PDF.</li>
</ul><p>In short: <strong>pages first → then chunks</strong> keeps the
workflow cleaner and easier to reason about.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="op">!</span>pip install pypdf</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="im">from</span> pypdf <span class="im">import</span> PdfReader</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="kw">def</span> pdfs_to_page_docs(metadata: pd.DataFrame, pdf_dir: <span class="bu">str</span>) <span class="op">-&gt;</span> List[Dict[<span class="bu">str</span>, Any]]:</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    <span class="co">"""Load each PDF into a list of page-level dictionaries.</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co">    Each dict has keys: text, doc_id, title, url, page_num, page_label, total_pages.</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    page_docs: List[Dict[<span class="bu">str</span>, Any]] <span class="op">=</span> []</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> metadata.iterrows():</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>        doc_id <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">"id"</span>]).strip()</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>        title <span class="op">=</span> <span class="bu">str</span>(row.get(<span class="st">"title"</span>, <span class="st">""</span>)).strip()</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>        url <span class="op">=</span> <span class="bu">str</span>(row.get(<span class="st">"url"</span>, <span class="st">""</span>)).strip()</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>        pdf_path <span class="op">=</span> os.path.join(pdf_dir, <span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(pdf_path):</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Missing PDF for </span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">, skipping."</span>)</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>            reader <span class="op">=</span> PdfReader(pdf_path)</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to read </span><span class="sc">{</span>pdf_path<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>        total_pages <span class="op">=</span> <span class="bu">len</span>(reader.pages)</span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>        <span class="cf">for</span> i, page <span class="kw">in</span> <span class="bu">enumerate</span>(reader.pages):</span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a>                text <span class="op">=</span> page.extract_text() <span class="kw">or</span> <span class="st">""</span></span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Failed to extract text from </span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss"> page </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a>                text <span class="op">=</span> <span class="st">""</span></span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a>            text <span class="op">=</span> text.strip()</span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> text:</span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a>                <span class="co"># Still keep the page so we know it exists, but mark it as empty</span></span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a>                text <span class="op">=</span> <span class="st">"[[EMPTY PAGE TEXT – see original PDF for tables/figures]]"</span></span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a>            page_docs.append(</span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a>                {</span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a>                    <span class="st">"text"</span>: text,</span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a>                    <span class="st">"doc_id"</span>: doc_id,</span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a>                    <span class="st">"title"</span>: title,</span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a>                    <span class="st">"url"</span>: url,</span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a>                    <span class="st">"page_num"</span>: i,</span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a>                    <span class="st">"page_label"</span>: <span class="bu">str</span>(i <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a>                    <span class="st">"total_pages"</span>: total_pages,</span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a>                }</span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a>            )</span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a></span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a>    <span class="cf">return</span> page_docs</span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a></span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a></span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a>page_docs <span class="op">=</span> pdfs_to_page_docs(metadata_df, PDF_DIR)</span>
<span id="cb13-55"><a href="#cb13-55" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(page_docs)<span class="sc">}</span><span class="ss"> page-level records from </span><span class="sc">{</span><span class="bu">len</span>(metadata_df)<span class="sc">}</span><span class="ss"> PDFs."</span>)</span>
<span id="cb13-56"><a href="#cb13-56" tabindex="-1"></a>page_docs[<span class="dv">0</span>] <span class="cf">if</span> page_docs <span class="cf">else</span> <span class="va">None</span></span></code></pre>
</div>
</div>
</section><section><h2 class="section-heading" id="step-4-simple-explicit-text-chunking">Step 4 – Simple, explicit text chunking<a class="anchor" aria-label="anchor" href="#step-4-simple-explicit-text-chunking"></a></h2>
<hr class="half-width"><p>RAG systems typically break documents into <strong>chunks</strong> so
that:</p>
<ul><li>Each chunk is long enough to carry meaningful context.</li>
<li>No chunk is so long that it blows up the embedding/LLM context
window.</li>
</ul><p>For this workshop we will implement a <strong>simple sliding-window
chunker</strong> that operates on characters:</p>
<ul><li>
<code>chunk_size_chars</code>: maximum characters per chunk (e.g.,
1,000–1,500).</li>
<li>
<code>chunk_overlap_chars</code>: overlap between consecutive chunks
(e.g., 200).</li>
</ul><p>In our own work, you may wish to plug in more sophisticated
<em>semantic chunking</em> methods(e.g., splitting on headings, section
titles, or sentence boundaries). For now, we’ll keep the implementation
explicit and easy to debug.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">def</span> split_text_into_chunks(</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    text: <span class="bu">str</span>,</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    chunk_size_chars: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1200</span>,</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    chunk_overlap_chars: <span class="bu">int</span> <span class="op">=</span> <span class="dv">200</span>,</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    <span class="co">"""Split `text` into overlapping character-based chunks.</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="co">    This is a simple baseline; more advanced versions might:</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="co">    - split on sentence boundaries, or</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="co">    - merge short paragraphs and respect section headings.</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>    text <span class="op">=</span> text.strip()</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> text:</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>    chunks: List[<span class="bu">str</span>] <span class="op">=</span> []</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>    start <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>    text_len <span class="op">=</span> <span class="bu">len</span>(text)</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>    <span class="cf">while</span> start <span class="op">&lt;</span> text_len:</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>        end <span class="op">=</span> <span class="bu">min</span>(start <span class="op">+</span> chunk_size_chars, text_len)</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>        chunk <span class="op">=</span> text[start:end]</span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>        chunks.append(chunk)</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>        <span class="cf">if</span> end <span class="op">==</span> text_len:</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>        <span class="co"># Move the window forward, keeping some overlap</span></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>        start <span class="op">=</span> end <span class="op">-</span> chunk_overlap_chars</span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a>    <span class="cf">return</span> chunks</span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a><span class="kw">def</span> make_chunked_docs(</span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a>    page_docs: List[Dict[<span class="bu">str</span>, Any]],</span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a>    chunk_size_chars: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1200</span>,</span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a>    chunk_overlap_chars: <span class="bu">int</span> <span class="op">=</span> <span class="dv">200</span>,</span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a>) <span class="op">-&gt;</span> List[Dict[<span class="bu">str</span>, Any]]:</span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a>    <span class="co">"""Turn page-level records into smaller overlapping text chunks.</span></span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a><span class="co">    Each chunk keeps a pointer back to its document and page metadata.</span></span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a>    chunked: List[Dict[<span class="bu">str</span>, Any]] <span class="op">=</span> []</span>
<span id="cb14-42"><a href="#cb14-42" tabindex="-1"></a>    <span class="cf">for</span> page <span class="kw">in</span> page_docs:</span>
<span id="cb14-43"><a href="#cb14-43" tabindex="-1"></a>        page_text <span class="op">=</span> page[<span class="st">"text"</span>]</span>
<span id="cb14-44"><a href="#cb14-44" tabindex="-1"></a>        chunks <span class="op">=</span> split_text_into_chunks(</span>
<span id="cb14-45"><a href="#cb14-45" tabindex="-1"></a>            page_text,</span>
<span id="cb14-46"><a href="#cb14-46" tabindex="-1"></a>            chunk_size_chars<span class="op">=</span>chunk_size_chars,</span>
<span id="cb14-47"><a href="#cb14-47" tabindex="-1"></a>            chunk_overlap_chars<span class="op">=</span>chunk_overlap_chars,</span>
<span id="cb14-48"><a href="#cb14-48" tabindex="-1"></a>        )</span>
<span id="cb14-49"><a href="#cb14-49" tabindex="-1"></a>        <span class="cf">for</span> idx, chunk_text <span class="kw">in</span> <span class="bu">enumerate</span>(chunks):</span>
<span id="cb14-50"><a href="#cb14-50" tabindex="-1"></a>            chunked.append(</span>
<span id="cb14-51"><a href="#cb14-51" tabindex="-1"></a>                {</span>
<span id="cb14-52"><a href="#cb14-52" tabindex="-1"></a>                    <span class="st">"text"</span>: chunk_text,</span>
<span id="cb14-53"><a href="#cb14-53" tabindex="-1"></a>                    <span class="st">"doc_id"</span>: page[<span class="st">"doc_id"</span>],</span>
<span id="cb14-54"><a href="#cb14-54" tabindex="-1"></a>                    <span class="st">"title"</span>: page[<span class="st">"title"</span>],</span>
<span id="cb14-55"><a href="#cb14-55" tabindex="-1"></a>                    <span class="st">"url"</span>: page[<span class="st">"url"</span>],</span>
<span id="cb14-56"><a href="#cb14-56" tabindex="-1"></a>                    <span class="st">"page_num"</span>: page[<span class="st">"page_num"</span>],</span>
<span id="cb14-57"><a href="#cb14-57" tabindex="-1"></a>                    <span class="st">"page_label"</span>: page[<span class="st">"page_label"</span>],</span>
<span id="cb14-58"><a href="#cb14-58" tabindex="-1"></a>                    <span class="st">"total_pages"</span>: page[<span class="st">"total_pages"</span>],</span>
<span id="cb14-59"><a href="#cb14-59" tabindex="-1"></a>                    <span class="st">"chunk_idx_in_page"</span>: idx,</span>
<span id="cb14-60"><a href="#cb14-60" tabindex="-1"></a>                }</span>
<span id="cb14-61"><a href="#cb14-61" tabindex="-1"></a>            )</span>
<span id="cb14-62"><a href="#cb14-62" tabindex="-1"></a>    <span class="cf">return</span> chunked</span>
<span id="cb14-63"><a href="#cb14-63" tabindex="-1"></a></span>
<span id="cb14-64"><a href="#cb14-64" tabindex="-1"></a></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="im">import</span> os, json</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>chunks_s3_key <span class="op">=</span> <span class="st">'chunks.jsonl'</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>chunks_jsonl_path <span class="op">=</span> os.path.join(local_data_dir, chunks_s3_key)</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="kw">def</span> save_chunked_docs_jsonl(path, chunks):</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>        <span class="cf">for</span> rec <span class="kw">in</span> chunks:</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>            json.dump(rec, f, ensure_ascii<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>            f.write(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="kw">def</span> load_chunked_docs_jsonl(path):</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>        <span class="cf">return</span> [json.loads(line) <span class="cf">for</span> line <span class="kw">in</span> f]</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co"># Cached chunking logic</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="cf">if</span> os.path.exists(chunks_jsonl_path):</span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Found existing chunk file: </span><span class="sc">{</span>chunks_jsonl_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>    chunked_docs <span class="op">=</span> load_chunked_docs_jsonl(chunks_jsonl_path)</span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Loaded chunked docs:"</span>, <span class="bu">len</span>(chunked_docs))</span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"No chunk file found. Running chunking step..."</span>)</span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>    chunked_docs <span class="op">=</span> make_chunked_docs(page_docs)</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>    save_chunked_docs_jsonl(chunks_jsonl_path, chunked_docs)</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saved chunked docs to </span><span class="sc">{</span>chunks_jsonl_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="co"># Show first chunk</span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Raw pages:"</span>, <span class="bu">len</span>(page_docs))</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Chunked docs:"</span>, <span class="bu">len</span>(chunked_docs))</span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a>chunked_docs[<span class="dv">0</span>] <span class="cf">if</span> chunked_docs <span class="cf">else</span> <span class="va">None</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co"># Upload to S3 so future runs (or other instances) can reuse</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Uploading chunked docs to s3 ..."</span>)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>s3_client.upload_file(chunks_jsonl_path, bucket_name, chunks_s3_key)</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Upload complete."</span>)</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="step-5-build-an-embedding-matrix">Step 5 – Build an embedding matrix<a class="anchor" aria-label="anchor" href="#step-5-build-an-embedding-matrix"></a></h2>
<hr class="half-width"><p>Now we embed each chunk into a vector using a
<strong>sentence-transformer</strong> model. For WattBot, a strong and
relatively efficient choice is:</p>
<div class="section level3">
<h3 id="thenlpergte-large-recommended-baseline-embedder">
<code>thenlper/gte-large</code> (Recommended baseline embedder)<a class="anchor" aria-label="anchor" href="#thenlpergte-large-recommended-baseline-embedder"></a></h3>
<ul><li><p>Size / parameters: ~335M parameters, roughly 1.3–1.4 GB in
BF16/FP16 when loaded on GPU. Fits cleanly on T4 (16 GB), L4, A10G, A10,
A100, and all g5.* instances. Offers noticeably better retrieval quality
than smaller 100M–150M models without requiring high-end GPU memory.
Runs comfortably on g4dn.xlarge, g5.xlarge, or g5.2xlarge during
workshops. Lets participants see meaningful improvements from chunking
and retrieval methods without excessive compute cost.</p></li>
<li><p>Intended use: General-purpose retrieval and semantic search
across academic PDFs, sustainability reports, and mixed-domain long-form
documents. Stronger semantic coherence than gte-base or MiniLM, but
still lightweight enough for workshop hardware.</p></li>
<li>
<p>Throughput expectations:</p>
<ul><li>CPU only: workable for small corpora (&lt;2k chunks) but slow for
anything larger.<br></li>
<li>GPU (T4, L4, A10G, A100) with batch sizes around 64–128:
<ul><li>20k–40k chunks/min on L4 or A10G<br></li>
<li>10k–15k chunks/min on T4<br></li>
<li>50k+ chunks/min on A100</li>
</ul></li>
</ul></li>
</ul><p>We will:</p>
<ol style="list-style-type: decimal"><li>Load the embedding model on GPU if available.</li>
<li>Encode all chunks in batches.</li>
<li>Store the resulting matrix as a <code>torch.Tensor</code> or
<code>numpy.ndarray</code> along with the original
<code>chunked_docs</code> list.</li>
</ol><p>Later, we’ll implement a small retrieval helper that does
cosine-similarity search over this matrix—no additional indexing library
required.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co"># We'll use a stronger embedding model now that we have a GPU.</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="co"># This model has ~335M parameters and benefits from GPU acceleration,</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="co"># but is still reasonable to run on a single 24 GB GPU.</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>embedding_model_id <span class="op">=</span> <span class="st">"thenlper/gte-large"</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>use_cuda_for_embeddings <span class="op">=</span> torch.cuda.is_available()</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CUDA available for embeddings:"</span>, use_cuda_for_embeddings)</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co"># Single shared embedder object that we can pass around.</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>embedder <span class="op">=</span> SentenceTransformer(</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>    embedding_model_id,</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>    device<span class="op">=</span><span class="st">"cuda"</span> <span class="cf">if</span> use_cuda_for_embeddings <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>)</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="kw">def</span> embed_texts(embedder, docs, batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">32</span>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="co">"""Embed all chunk texts into a dense matrix of shape (N, D)."""</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    texts <span class="op">=</span> [d[<span class="st">"text"</span>] <span class="cf">for</span> d <span class="kw">in</span> docs]</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    all_embeddings <span class="op">=</span> []</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>    start <span class="op">=</span> time.time()</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(texts), batch_size):</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>        batch <span class="op">=</span> texts[i : i <span class="op">+</span> batch_size]</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>        emb <span class="op">=</span> embedder.encode(</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>            batch,</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>            convert_to_numpy<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>            show_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>            normalize_embeddings<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>        )</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>        all_embeddings.append(emb)</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>    embeddings <span class="op">=</span> np.vstack(all_embeddings) <span class="cf">if</span> all_embeddings <span class="cf">else</span> np.zeros((<span class="dv">0</span>, <span class="dv">768</span>))</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Computed embeddings for </span><span class="sc">{</span><span class="bu">len</span>(texts)<span class="sc">}</span><span class="ss"> chunks in </span><span class="sc">{</span>time<span class="sc">.</span>time() <span class="op">-</span> start<span class="sc">:.1f}</span><span class="ss">s"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>    <span class="cf">return</span> embeddings</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>chunk_embeddings <span class="op">=</span> embed_texts(embedder, chunked_docs)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>chunk_embeddings.shape</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="build-a-simple-retrieval-step-cosine-similarity">6. Build a simple retrieval step (cosine similarity)<a class="anchor" aria-label="anchor" href="#build-a-simple-retrieval-step-cosine-similarity"></a></h3>
<p>We are <strong>not</strong> using a heavy vector database in this
first episode.</p>
<p>Instead, we:</p>
<ol style="list-style-type: decimal"><li>Embed each chunk with <code>thenlper/gte-large</code> (done
above).</li>
<li>Embed each question.</li>
<li>Compute cosine similarity between the question embedding and all
chunk embeddings.</li>
<li>Take the top–k most similar chunks as our retrieved context.</li>
</ol><p>This keeps the retrieval logic completely transparent for teaching,
while still matching the <em>spirit</em> of production systems that use
FAISS, Chroma, Weaviate, etc.</p>
<div class="section level4">
<h4 id="when-might-faiss-or-a-vector-database-be-worth-exploring">When might FAISS or a vector database be worth exploring?<a class="anchor" aria-label="anchor" href="#when-might-faiss-or-a-vector-database-be-worth-exploring"></a></h4>
<p>For small–to–medium experiments (a few thousand to maybe tens of
thousands of chunks), this “plain NumPy + cosine similarity” approach is
usually enough. You might consider FAISS or a full vector DB when:</p>
<ul><li><p><strong>Your corpus gets big</strong><br>
Once you’re in the hundreds of thousands to millions of chunks,
brute-force similarity search can become slow and memory-hungry. FAISS
and friends provide <em>approximate nearest neighbor</em> search that
scales much better.</p></li>
<li>
<p><strong>You need low-latency, repeated queries</strong><br>
If many users (or a web app) will hit your RAG system concurrently,
you’ll want:</p>
<ul><li>fast indexing,</li>
<li>efficient caching, and</li>
<li>sub-second query latency.<br>
Vector DBs are designed for this use case.</li>
</ul></li>
<li>
<p><strong>You need rich filtering or metadata search</strong><br>
Vector DBs often support:</p>
<ul><li>filtering by metadata (e.g., <code>paper = "chung2025"</code>,
<code>year &gt; 2021</code>),</li>
<li>combining keyword + vector search (“hybrid search”),</li>
<li>role-based access control and multi-tenant setups.</li>
</ul></li>
<li><p><strong>You want to share an index across services</strong><br>
If multiple notebooks, microservices, or teams need to reuse the
<strong>same embedding index</strong>, a shared FAISS index or hosted
vector DB is much easier to manage than passing around <code>.npy</code>
files.</p></li>
<li><p><strong>You need GPU-accelerated or distributed
search</strong><br>
FAISS can use GPUs and sharding to speed up search on very large
embedding collections. This is overkill for our teaching demo (and the
Wattbot project in general), but very relevant for production-scale
systems.</p></li>
</ul><p>In this episode we deliberately stick with a simple in-memory index
so the retrieval step is easy to inspect and debug. In later episodes
(or your own projects), you can <strong>swap out the retrieval
layer</strong> for FAISS or a vector DB without changing the overall RAG
architecture: the model still sees “top–k retrieved chunks” as
context.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Any</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="kw">def</span> cosine_similarity_matrix(a: np.ndarray, b: np.ndarray) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>    <span class="co">"""Compute cosine similarity between rows of a and rows of b."""</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    a_norm <span class="op">=</span> a <span class="op">/</span> (np.linalg.norm(a, axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>) <span class="op">+</span> <span class="fl">1e-12</span>)</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>    b_norm <span class="op">=</span> b <span class="op">/</span> (np.linalg.norm(b, axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>) <span class="op">+</span> <span class="fl">1e-12</span>)</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>    <span class="cf">return</span> np.dot(a_norm, b_norm.T)</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="kw">def</span> retrieve_top_k(</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>    query_embedding: np.ndarray,</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>    chunk_embeddings: np.ndarray,</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>    chunked_docs: List[Dict[<span class="bu">str</span>, Any]],</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>    k: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>) <span class="op">-&gt;</span> List[Dict[<span class="bu">str</span>, Any]]:</span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>    <span class="co">"""Return top-k most similar chunks for a query embedding."""</span></span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>    <span class="cf">if</span> chunk_embeddings.shape[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a>    <span class="co"># query_embedding is 1D (D,)</span></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a>    sims <span class="op">=</span> cosine_similarity_matrix(query_embedding.reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>), chunk_embeddings)[<span class="dv">0</span>]</span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a>    top_idx <span class="op">=</span> np.argsort(<span class="op">-</span>sims)[:k]</span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a>    results: List[Dict[<span class="bu">str</span>, Any]] <span class="op">=</span> []</span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> top_idx:</span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a>        doc <span class="op">=</span> chunked_docs[idx]</span>
<span id="cb20-27"><a href="#cb20-27" tabindex="-1"></a>        results.append(</span>
<span id="cb20-28"><a href="#cb20-28" tabindex="-1"></a>            {</span>
<span id="cb20-29"><a href="#cb20-29" tabindex="-1"></a>                <span class="st">"score"</span>: <span class="bu">float</span>(sims[idx]),</span>
<span id="cb20-30"><a href="#cb20-30" tabindex="-1"></a>                <span class="st">"text"</span>: doc[<span class="st">"text"</span>],</span>
<span id="cb20-31"><a href="#cb20-31" tabindex="-1"></a>                <span class="st">"doc_id"</span>: doc[<span class="st">"doc_id"</span>],</span>
<span id="cb20-32"><a href="#cb20-32" tabindex="-1"></a>                <span class="st">"page_num"</span>: doc[<span class="st">"page_num"</span>],</span>
<span id="cb20-33"><a href="#cb20-33" tabindex="-1"></a>                <span class="st">"title"</span>: doc[<span class="st">"title"</span>],</span>
<span id="cb20-34"><a href="#cb20-34" tabindex="-1"></a>                <span class="st">"url"</span>: doc[<span class="st">"url"</span>],</span>
<span id="cb20-35"><a href="#cb20-35" tabindex="-1"></a>            }</span>
<span id="cb20-36"><a href="#cb20-36" tabindex="-1"></a>        )</span>
<span id="cb20-37"><a href="#cb20-37" tabindex="-1"></a>    <span class="cf">return</span> results</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="co"># Quick sanity check for `retrieve_top_k` on the first training question</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>first_row <span class="op">=</span> train_df.iloc[<span class="dv">0</span>]</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>test_question <span class="op">=</span> first_row[<span class="st">"question"</span>]</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sample question:"</span>, test_question)</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>test_q_emb <span class="op">=</span> embedder.encode(</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>    [test_question],</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>    convert_to_numpy<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>    normalize_embeddings<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>)[<span class="dv">0</span>]</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>test_retrieved <span class="op">=</span> retrieve_top_k(</span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>    query_embedding<span class="op">=</span>test_q_emb,</span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>    chunk_embeddings<span class="op">=</span>chunk_embeddings,</span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>    chunked_docs<span class="op">=</span>chunked_docs,</span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a>    k<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a>)</span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Top </span><span class="sc">{</span><span class="bu">len</span>(test_retrieved)<span class="sc">}</span><span class="ss"> retrieved chunks:"</span>)</span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> test_retrieved:</span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a>    snippet <span class="op">=</span> r[<span class="st">"text"</span>].replace(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="st">" "</span>)</span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(snippet) <span class="op">&gt;</span> <span class="dv">160</span>:</span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a>        snippet <span class="op">=</span> snippet[:<span class="dv">160</span>] <span class="op">+</span> <span class="st">"..."</span></span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"- score=</span><span class="sc">{</span>r[<span class="st">'score'</span>]<span class="sc">:.3f}</span><span class="ss"> | doc_id=</span><span class="sc">{</span>r[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ss"> | page=</span><span class="sc">{</span>r[<span class="st">'page_num'</span>]<span class="sc">}</span><span class="ss"> | snippet=</span><span class="sc">{</span>snippet<span class="sc">}</span><span class="ss">"</span>)</span></code></pre>
</div>
</div>
</div>
<div class="section level3">
<h3 id="load-the-qwen-model-for-answer-generation">7. Load the Qwen model for answer generation<a class="anchor" aria-label="anchor" href="#load-the-qwen-model-for-answer-generation"></a></h3>
<p>For this episode we use <strong>Qwen2.5-7B-Instruct</strong> via the
Hugging Face <code>transformers</code> library.</p>
<ul><li>Parameter count: ~7 billion.</li>
<li>VRAM needs: ~14–16 GB in bfloat16 / 4-bit; fine for
<code>ml.g5.xlarge</code> or a similar single-GPU instance.</li>
<li>Intended use here: short, grounded answers plus a normalized
<code>answer_value</code>.</li>
</ul><p>We will:</p>
<ol style="list-style-type: decimal"><li>Call Qwen once to propose an answer and supporting evidence.</li>
<li>Call Qwen a <strong>second time</strong> with a smaller prompt to
generate a short explanation (&lt;= 100 characters).</li>
</ol><div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForCausalLM, AutoTokenizer, pipeline</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>qwen_model_id <span class="op">=</span> <span class="st">"Qwen/Qwen2.5-7B-Instruct"</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>use_cuda_for_llm <span class="op">=</span> torch.cuda.is_available()</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CUDA available for LLM:"</span>, use_cuda_for_llm)</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>tokenizer_qwen <span class="op">=</span> AutoTokenizer.from_pretrained(qwen_model_id)</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="cf">if</span> use_cuda_for_llm:</span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>    llm_dtype <span class="op">=</span> torch.bfloat16</span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>    model_qwen <span class="op">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>        qwen_model_id,</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a>        dtype<span class="op">=</span>llm_dtype,</span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>        device_map<span class="op">=</span><span class="va">None</span>,  <span class="co"># load on a single GPU</span></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>    ).to(<span class="st">"cuda"</span>)</span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>    generation_device <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>    llm_dtype <span class="op">=</span> torch.float32</span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a>    model_qwen <span class="op">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a>        qwen_model_id,</span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a>        dtype<span class="op">=</span>llm_dtype,</span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a>        device_map<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a>    )</span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a>    generation_device <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>  <span class="co"># CPU</span></span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a>qwen_pipe <span class="op">=</span> pipeline(</span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a>    <span class="st">"text-generation"</span>,</span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a>    model<span class="op">=</span>model_qwen,</span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a>    tokenizer<span class="op">=</span>tokenizer_qwen,</span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a>    device<span class="op">=</span>generation_device,</span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a>    max_new_tokens<span class="op">=</span><span class="dv">384</span>,</span>
<span id="cb22-34"><a href="#cb22-34" tabindex="-1"></a>)</span>
<span id="cb22-35"><a href="#cb22-35" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" tabindex="-1"></a><span class="kw">def</span> call_qwen_chat(system_prompt: <span class="bu">str</span>, user_prompt: <span class="bu">str</span>, max_new_tokens: <span class="bu">int</span> <span class="op">=</span> <span class="dv">384</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb22-37"><a href="#cb22-37" tabindex="-1"></a>    <span class="co">"""Use Qwen chat template and return only the newly generated text."""</span></span>
<span id="cb22-38"><a href="#cb22-38" tabindex="-1"></a>    messages <span class="op">=</span> [</span>
<span id="cb22-39"><a href="#cb22-39" tabindex="-1"></a>        {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_prompt},</span>
<span id="cb22-40"><a href="#cb22-40" tabindex="-1"></a>        {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: user_prompt},</span>
<span id="cb22-41"><a href="#cb22-41" tabindex="-1"></a>    ]</span>
<span id="cb22-42"><a href="#cb22-42" tabindex="-1"></a>    prompt_text <span class="op">=</span> tokenizer_qwen.apply_chat_template(</span>
<span id="cb22-43"><a href="#cb22-43" tabindex="-1"></a>        messages,</span>
<span id="cb22-44"><a href="#cb22-44" tabindex="-1"></a>        tokenize<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb22-45"><a href="#cb22-45" tabindex="-1"></a>        add_generation_prompt<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-46"><a href="#cb22-46" tabindex="-1"></a>    )</span>
<span id="cb22-47"><a href="#cb22-47" tabindex="-1"></a>    outputs <span class="op">=</span> qwen_pipe(</span>
<span id="cb22-48"><a href="#cb22-48" tabindex="-1"></a>        prompt_text,</span>
<span id="cb22-49"><a href="#cb22-49" tabindex="-1"></a>        max_new_tokens<span class="op">=</span>max_new_tokens,</span>
<span id="cb22-50"><a href="#cb22-50" tabindex="-1"></a>        do_sample<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb22-51"><a href="#cb22-51" tabindex="-1"></a>    )</span>
<span id="cb22-52"><a href="#cb22-52" tabindex="-1"></a>    full <span class="op">=</span> outputs[<span class="dv">0</span>][<span class="st">"generated_text"</span>]</span>
<span id="cb22-53"><a href="#cb22-53" tabindex="-1"></a>    generated <span class="op">=</span> full[<span class="bu">len</span>(prompt_text):]</span>
<span id="cb22-54"><a href="#cb22-54" tabindex="-1"></a>    <span class="cf">return</span> generated.strip()</span>
<span id="cb22-55"><a href="#cb22-55" tabindex="-1"></a></span>
<span id="cb22-56"><a href="#cb22-56" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Generator model and helper loaded."</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="co"># Quick sanity check for `call_qwen_chat`</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>test_system_prompt <span class="op">=</span> <span class="st">"You are a concise assistant who answers simple questions clearly."</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>test_user_prompt <span class="op">=</span> <span class="st">"What is 2 + 2? Answer in one short sentence."</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>test_response <span class="op">=</span> call_qwen_chat(</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>    system_prompt<span class="op">=</span>test_system_prompt,</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>    user_prompt<span class="op">=</span>test_user_prompt,</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>    max_new_tokens<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>)</span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Generator (</span><span class="sc">{</span>qwen_model_id<span class="sc">}</span><span class="ss">) test response: </span><span class="sc">{</span>test_response<span class="sc">}</span><span class="ss">"</span>)</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="build-prompts-for-answers-and-explanations">8. Build prompts for answers and explanations<a class="anchor" aria-label="anchor" href="#build-prompts-for-answers-and-explanations"></a></h3>
<p>We keep the prompts <strong>very explicit</strong>:</p>
<ul><li>The first call asks Qwen to return JSON with:
<ul><li>
<code>answer</code> (short text),</li>
<li>
<code>answer_value</code> (normalized scalar or category),</li>
<li>
<code>ref_id</code> (comma‑separated doc ids,
e.g. <code>"jegham2025"</code>),</li>
<li>
<code>supporting_material</code> (short quote or paraphrase).</li>
</ul></li>
<li>The second call asks Qwen to generate a <strong>single sentence
explanation</strong> (&lt;= 100 characters). We will prepend an evidence
type tag (e.g. <code>[text]</code> or <code>[text+table]</code>) in code
rather than asking the model to output it.</li>
</ul><div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="kw">def</span> format_context_for_prompt(retrieved_chunks):</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>    <span class="co">"""Format retrieved chunks so the LLM can see where text came from."""</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>    blocks <span class="op">=</span> []</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> retrieved_chunks:</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>        header <span class="op">=</span> <span class="ss">f"[DOC </span><span class="sc">{</span>r[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ss"> | page </span><span class="sc">{</span>r[<span class="st">'page_num'</span>]<span class="sc">}</span><span class="ss"> | score </span><span class="sc">{</span>r[<span class="st">'score'</span>]<span class="sc">:.3f}</span><span class="ss">]"</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>        blocks.append(header <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> r[<span class="st">"text"</span>])</span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join(blocks)</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>explanation_system_prompt <span class="op">=</span> (</span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>    <span class="st">"You are helping annotate how an answer is supported by a research paper. "</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>    <span class="st">"You will see a question, an answer, and the supporting text used. "</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>    <span class="st">"Your job is to (1) choose the MAIN type of evidence and "</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>    <span class="st">"(2) give a VERY short explanation (&lt;= 100 characters). "</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>    <span class="st">"Valid evidence types are: text, figure, table, text+figure, table+figure, etc. "</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>    <span class="st">"Respond in the strict format: evidence_type: explanation"</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>)</span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a><span class="kw">def</span> build_explanation_prompt(question, answer, supporting_materials, ref_id_list):</span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a>    ref_str <span class="op">=</span> <span class="st">", "</span>.join(ref_id_list) <span class="cf">if</span> ref_id_list <span class="cf">else</span> <span class="st">"unknown"</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""Question: </span><span class="sc">{</span>question<span class="sc">}</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a><span class="ss">Answer: </span><span class="sc">{</span>answer<span class="sc">}</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a><span class="ss">Supporting materials:</span></span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a><span class="sc">{</span>supporting_materials<span class="sc">}</span></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a><span class="ss">Cited document ids: </span><span class="sc">{</span>ref_str<span class="sc">}</span></span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a><span class="ss">Remember:</span></span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a><span class="ss">- evidence_type in [text, figure, table, text+figure, table+figure, etc.]</span></span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a><span class="ss">- explanation &lt;= 100 characters</span></span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a><span class="ss">- Format: evidence_type: explanation</span></span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a><span class="ss">"""</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="run-over-the-full-wattbot-training-set">9. Run over the full WattBot training set<a class="anchor" aria-label="anchor" href="#run-over-the-full-wattbot-training-set"></a></h3>
<p>Now we:</p>
<ol style="list-style-type: decimal"><li>Iterate over <strong>all</strong> questions in
<code>train_QA.csv</code>.</li>
<li>Retrieve the top-<span class="math inline">\(k\)</span> chunks for
each question.</li>
<li>Ask Qwen for an answer proposal (JSON).</li>
<li>Derive:
<ul><li>
<code>answer</code> and <code>answer_value</code> from the
JSON,</li>
<li>
<code>answer_unit</code> <strong>copied directly from the ground
truth</strong> (never guessed),</li>
<li>
<code>ref_id</code> from the JSON,</li>
<li>
<code>ref_url</code> by mapping <code>ref_id</code> to
<code>metadata.csv</code>,</li>
<li>
<code>supporting_material</code> from the JSON,</li>
<li>
<code>evidence_type</code> from the supporting text,</li>
<li>
<code>explanation</code> via a second Qwen call, prefixed with
<code>[evidence_type]</code>.</li>
</ul></li>
<li>Save <code>wattbot_solutions.csv</code> in the project folder.</li>
</ol><div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="im">from</span> decimal <span class="im">import</span> Decimal</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="kw">def</span> normalize_answer_value(raw_answer_value, answer_text, answer_unit, is_blank):</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co">    Normalize answer_value into the conventions used by train_QA:</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="co">      - 'is_blank' for unanswerable questions</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co">      - plain numeric strings without units, commas, or scientific notation</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="co">      - booleans as 1/0</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a><span class="co">      - categorical strings (e.g., 'ML.ENERGY Benchmark') unchanged</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="co">      - ranges like '[0.02,0.1]' preserved as-is</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(raw_answer_value).strip()</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>    <span class="cf">if</span> is_blank:</span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"is_blank"</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> s <span class="kw">or</span> s.lower() <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"is_blank"</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>    <span class="co"># Preserve ranges like [0.02,0.1]</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>    <span class="cf">if</span> s.startswith(<span class="st">"["</span>) <span class="kw">and</span> s.endswith(<span class="st">"]"</span>):</span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>        <span class="cf">return</span> s</span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>    lower <span class="op">=</span> s.lower()</span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a>    <span class="co"># Booleans -&gt; 1/0</span></span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a>    <span class="cf">if</span> lower <span class="kw">in</span> {<span class="st">"true"</span>, <span class="st">"false"</span>}:</span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"1"</span> <span class="cf">if</span> lower <span class="op">==</span> <span class="st">"true"</span> <span class="cf">else</span> <span class="st">"0"</span></span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>    <span class="co"># Pure categorical (no digits) -&gt; leave as-is</span></span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(ch.isdigit() <span class="cf">for</span> ch <span class="kw">in</span> s):</span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a>        <span class="cf">return</span> s</span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a>    <span class="co"># Try to extract the first numeric token from either the raw string or the answer text</span></span>
<span id="cb25-34"><a href="#cb25-34" tabindex="-1"></a>    txt_candidates <span class="op">=</span> [s, <span class="bu">str</span>(answer_text)]</span>
<span id="cb25-35"><a href="#cb25-35" tabindex="-1"></a>    match <span class="op">=</span> <span class="va">None</span></span>
<span id="cb25-36"><a href="#cb25-36" tabindex="-1"></a>    <span class="cf">for</span> txt <span class="kw">in</span> txt_candidates:</span>
<span id="cb25-37"><a href="#cb25-37" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> txt:</span>
<span id="cb25-38"><a href="#cb25-38" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb25-39"><a href="#cb25-39" tabindex="-1"></a>        match <span class="op">=</span> re.search(<span class="vs">r"[-+]?\d*\.?\d+(?:[eE][-+]?\d+)?"</span>, <span class="bu">str</span>(txt).replace(<span class="st">","</span>, <span class="st">""</span>))</span>
<span id="cb25-40"><a href="#cb25-40" tabindex="-1"></a>        <span class="cf">if</span> match:</span>
<span id="cb25-41"><a href="#cb25-41" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb25-42"><a href="#cb25-42" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> match:</span>
<span id="cb25-44"><a href="#cb25-44" tabindex="-1"></a>        <span class="co"># Fallback: strip obvious formatting characters</span></span>
<span id="cb25-45"><a href="#cb25-45" tabindex="-1"></a>        cleaned <span class="op">=</span> s.replace(<span class="st">","</span>, <span class="st">""</span>).replace(<span class="st">"%"</span>, <span class="st">""</span>).strip()</span>
<span id="cb25-46"><a href="#cb25-46" tabindex="-1"></a>        <span class="cf">return</span> cleaned <span class="kw">or</span> <span class="st">"is_blank"</span></span>
<span id="cb25-47"><a href="#cb25-47" tabindex="-1"></a></span>
<span id="cb25-48"><a href="#cb25-48" tabindex="-1"></a>    num_str <span class="op">=</span> match.group(<span class="dv">0</span>)</span>
<span id="cb25-49"><a href="#cb25-49" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" tabindex="-1"></a>    <span class="co"># Format without scientific notation, trim trailing zeros</span></span>
<span id="cb25-51"><a href="#cb25-51" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb25-52"><a href="#cb25-52" tabindex="-1"></a>        d <span class="op">=</span> Decimal(num_str)</span>
<span id="cb25-53"><a href="#cb25-53" tabindex="-1"></a>        normalized <span class="op">=</span> <span class="bu">format</span>(d.normalize(), <span class="st">"f"</span>)</span>
<span id="cb25-54"><a href="#cb25-54" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb25-55"><a href="#cb25-55" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb25-56"><a href="#cb25-56" tabindex="-1"></a>            f <span class="op">=</span> <span class="bu">float</span>(num_str)</span>
<span id="cb25-57"><a href="#cb25-57" tabindex="-1"></a>            normalized <span class="op">=</span> (<span class="st">"</span><span class="sc">%.15f</span><span class="st">"</span> <span class="op">%</span> f).rstrip(<span class="st">"0"</span>).rstrip(<span class="st">"."</span>)</span>
<span id="cb25-58"><a href="#cb25-58" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb25-59"><a href="#cb25-59" tabindex="-1"></a>            normalized <span class="op">=</span> num_str</span>
<span id="cb25-60"><a href="#cb25-60" tabindex="-1"></a></span>
<span id="cb25-61"><a href="#cb25-61" tabindex="-1"></a>    <span class="cf">return</span> normalized</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="running-the-full-rag-pipeline-for-one-question">Running the full RAG pipeline for one question<a class="anchor" aria-label="anchor" href="#running-the-full-rag-pipeline-for-one-question"></a></h3>
<p>At this point we have all the building blocks we need:</p>
<ul><li>an <strong>embedder</strong> to turn questions into vectors<br></li>
<li>a <strong>retriever</strong> (<code>retrieve_top_k</code>) to grab
the most relevant text chunks<br></li>
<li>a <strong>chat helper</strong> (<code>call_qwen_chat</code>) to talk
to Qwen and get JSON back<br></li>
<li>a small post-processing helper (<code>normalize_answer_value</code>)
to clean numbers</li>
</ul><p>In the next few cells we tie these pieces together. We keep the code
split into small helper functions so learners can follow each step:</p>
<ol style="list-style-type: decimal"><li>Retrieve context for a question.<br></li>
<li>Ask the LLM for an answer, references, and a quote.<br></li>
<li>Clean and normalize the structured fields (answer_value, ref_id,
is_blank).<br></li>
<li>Ask a second LLM call for a short explanation and evidence
type.</li>
</ol></div>
<div class="section level3">
<h3 id="retrieving-relevant-context">🔍 Retrieving Relevant Context<a class="anchor" aria-label="anchor" href="#retrieving-relevant-context"></a></h3>
<p>This function embeds the question and fetches the top‐K most relevant
text chunks. It’s the first step of the RAG pipeline and determines what
evidence the LLM can see.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># Build a lookup from document id -&gt; URL using metadata</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>docid_to_url <span class="op">=</span> {</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>    <span class="bu">str</span>(row[<span class="st">"id"</span>]).strip(): row[<span class="st">"url"</span>]</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> metadata_df.iterrows()</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(row.get(<span class="st">"url"</span>, <span class="va">None</span>), <span class="bu">str</span>)</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>}</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a><span class="kw">def</span> retrieve_context_for_question(question, embedder, chunk_embeddings, chunked_docs, top_k: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>):</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>    <span class="co">"""Embed the question and retrieve the top-k most similar chunks."""</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>    q_emb <span class="op">=</span> embedder.encode(</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>        [question],</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>        convert_to_numpy<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>        normalize_embeddings<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>    )[<span class="dv">0</span>]</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a>    retrieved <span class="op">=</span> retrieve_top_k(q_emb, chunk_embeddings, chunked_docs, k<span class="op">=</span>top_k)</span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>    context <span class="op">=</span> format_context_for_prompt(retrieved)</span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a>    <span class="cf">return</span> retrieved, context</span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="first-llm-step-producing-an-answer">First LLM Step: Producing an Answer<a class="anchor" aria-label="anchor" href="#first-llm-step-producing-an-answer"></a></h3>
<p>Here we prompt the model to: - Decide if the question is answerable -
Extract a numeric/categorical answer - Identify supporting evidence -
Select relevant document IDs</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="kw">def</span> answer_phase_for_question(qid, question, answer_unit, context):</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="co">    First LLM call: ask Qwen for an answer, answer_value, is_blank, ref_ids,</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="co">    and a short supporting quote. Then normalize these fields.</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>    <span class="co"># System prompt: what role Qwen should play</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>    system_prompt_answer <span class="op">=</span> (</span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a>        <span class="st">"You answer questions about AI energy, carbon, and water from academic papers.</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a>        <span class="st">"You are given:</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a>        <span class="st">"- a question</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a>        <span class="st">"- retrieved text chunks from the relevant paper(s)</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a>        <span class="st">"You must:</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a>        <span class="st">"1. Decide if the question can be answered from the provided context.</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a>        <span class="st">"2. If answerable, extract a concise numeric or short-text answer_value.</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a>        <span class="st">"3. Use the provided answer_unit EXACTLY as given (do NOT invent units).</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a>        <span class="st">"4. Select one or more document ids as ref_id from the supplied chunks.</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a>        <span class="st">"5. Copy a short supporting quote (&lt;= 300 chars) into supporting_materials.</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-18"><a href="#cb27-18" tabindex="-1"></a>        <span class="st">"6. If the context is insufficient, mark is_blank = true and set all</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-19"><a href="#cb27-19" tabindex="-1"></a>        <span class="st">"   other fields to 'is_blank' except answer_unit (keep it as provided).</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-20"><a href="#cb27-20" tabindex="-1"></a>        <span class="st">"Return a JSON object with fields:</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-21"><a href="#cb27-21" tabindex="-1"></a>        <span class="st">"  answer (string)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-22"><a href="#cb27-22" tabindex="-1"></a>        <span class="st">"  answer_value (string)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-23"><a href="#cb27-23" tabindex="-1"></a>        <span class="st">"  is_blank (true or false)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-24"><a href="#cb27-24" tabindex="-1"></a>        <span class="st">"  ref_id (list of doc_id strings)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-25"><a href="#cb27-25" tabindex="-1"></a>        <span class="st">"  supporting_materials (string)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb27-26"><a href="#cb27-26" tabindex="-1"></a>    )</span>
<span id="cb27-27"><a href="#cb27-27" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" tabindex="-1"></a>    context_block <span class="op">=</span> context <span class="cf">if</span> context.strip() <span class="cf">else</span> <span class="st">"[NO CONTEXT FOUND]"</span></span>
<span id="cb27-29"><a href="#cb27-29" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" tabindex="-1"></a>    <span class="co"># User prompt: question + unit hint + retrieved context</span></span>
<span id="cb27-31"><a href="#cb27-31" tabindex="-1"></a>    user_prompt_answer <span class="op">=</span> <span class="ss">f"""Question: </span><span class="sc">{</span>question<span class="sc">}</span></span>
<span id="cb27-32"><a href="#cb27-32" tabindex="-1"></a><span class="ss">Expected answer unit: </span><span class="sc">{</span>answer_unit<span class="sc">}</span></span>
<span id="cb27-33"><a href="#cb27-33" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" tabindex="-1"></a><span class="ss">Retrieved context:</span></span>
<span id="cb27-35"><a href="#cb27-35" tabindex="-1"></a><span class="sc">{</span>context_block<span class="sc">}</span></span>
<span id="cb27-36"><a href="#cb27-36" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" tabindex="-1"></a><span class="ss">Return JSON ONLY with keys:</span></span>
<span id="cb27-38"><a href="#cb27-38" tabindex="-1"></a><span class="ss">  answer (string)</span></span>
<span id="cb27-39"><a href="#cb27-39" tabindex="-1"></a><span class="ss">  answer_value (string)</span></span>
<span id="cb27-40"><a href="#cb27-40" tabindex="-1"></a><span class="ss">  is_blank (true or false)</span></span>
<span id="cb27-41"><a href="#cb27-41" tabindex="-1"></a><span class="ss">  ref_id (list of doc_id strings)</span></span>
<span id="cb27-42"><a href="#cb27-42" tabindex="-1"></a><span class="ss">  supporting_materials (string)</span></span>
<span id="cb27-43"><a href="#cb27-43" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb27-44"><a href="#cb27-44" tabindex="-1"></a></span>
<span id="cb27-45"><a href="#cb27-45" tabindex="-1"></a>    raw_answer <span class="op">=</span> call_qwen_chat(system_prompt_answer, user_prompt_answer, max_new_tokens<span class="op">=</span><span class="dv">384</span>)</span>
<span id="cb27-46"><a href="#cb27-46" tabindex="-1"></a></span>
<span id="cb27-47"><a href="#cb27-47" tabindex="-1"></a>    <span class="co"># Try to parse JSON from the model output</span></span>
<span id="cb27-48"><a href="#cb27-48" tabindex="-1"></a>    parsed <span class="op">=</span> {</span>
<span id="cb27-49"><a href="#cb27-49" tabindex="-1"></a>        <span class="st">"answer"</span>: <span class="st">""</span>,</span>
<span id="cb27-50"><a href="#cb27-50" tabindex="-1"></a>        <span class="st">"answer_value"</span>: <span class="st">"is_blank"</span>,</span>
<span id="cb27-51"><a href="#cb27-51" tabindex="-1"></a>        <span class="st">"is_blank"</span>: <span class="va">True</span>,</span>
<span id="cb27-52"><a href="#cb27-52" tabindex="-1"></a>        <span class="st">"ref_id"</span>: [],</span>
<span id="cb27-53"><a href="#cb27-53" tabindex="-1"></a>        <span class="st">"supporting_materials"</span>: <span class="st">"is_blank"</span>,</span>
<span id="cb27-54"><a href="#cb27-54" tabindex="-1"></a>    }</span>
<span id="cb27-55"><a href="#cb27-55" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb27-56"><a href="#cb27-56" tabindex="-1"></a>        first_brace <span class="op">=</span> raw_answer.find(<span class="st">"{"</span>)</span>
<span id="cb27-57"><a href="#cb27-57" tabindex="-1"></a>        last_brace <span class="op">=</span> raw_answer.rfind(<span class="st">"}"</span>)</span>
<span id="cb27-58"><a href="#cb27-58" tabindex="-1"></a>        <span class="cf">if</span> first_brace <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">and</span> last_brace <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb27-59"><a href="#cb27-59" tabindex="-1"></a>            json_str <span class="op">=</span> raw_answer[first_brace : last_brace <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb27-60"><a href="#cb27-60" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb27-61"><a href="#cb27-61" tabindex="-1"></a>            json_str <span class="op">=</span> raw_answer</span>
<span id="cb27-62"><a href="#cb27-62" tabindex="-1"></a>        candidate <span class="op">=</span> json.loads(json_str)</span>
<span id="cb27-63"><a href="#cb27-63" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(candidate, <span class="bu">dict</span>):</span>
<span id="cb27-64"><a href="#cb27-64" tabindex="-1"></a>            parsed.update(candidate)</span>
<span id="cb27-65"><a href="#cb27-65" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb27-66"><a href="#cb27-66" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"JSON parse error for question </span><span class="sc">{</span>qid<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-67"><a href="#cb27-67" tabindex="-1"></a>        <span class="co"># fall back to defaults in `parsed`</span></span>
<span id="cb27-68"><a href="#cb27-68" tabindex="-1"></a></span>
<span id="cb27-69"><a href="#cb27-69" tabindex="-1"></a>    <span class="co"># Normalize parsed fields</span></span>
<span id="cb27-70"><a href="#cb27-70" tabindex="-1"></a>    is_blank <span class="op">=</span> <span class="bu">bool</span>(parsed.get(<span class="st">"is_blank"</span>, <span class="va">False</span>))</span>
<span id="cb27-71"><a href="#cb27-71" tabindex="-1"></a>    ref_ids <span class="op">=</span> parsed.get(<span class="st">"ref_id"</span>) <span class="kw">or</span> []</span>
<span id="cb27-72"><a href="#cb27-72" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(ref_ids, <span class="bu">str</span>):</span>
<span id="cb27-73"><a href="#cb27-73" tabindex="-1"></a>        ref_ids <span class="op">=</span> [ref_ids]</span>
<span id="cb27-74"><a href="#cb27-74" tabindex="-1"></a>    ref_ids <span class="op">=</span> [<span class="bu">str</span>(r).strip() <span class="cf">for</span> r <span class="kw">in</span> ref_ids <span class="cf">if</span> <span class="bu">str</span>(r).strip()]</span>
<span id="cb27-75"><a href="#cb27-75" tabindex="-1"></a></span>
<span id="cb27-76"><a href="#cb27-76" tabindex="-1"></a>    answer <span class="op">=</span> <span class="bu">str</span>(parsed.get(<span class="st">"answer"</span>, <span class="st">""</span>)).strip()</span>
<span id="cb27-77"><a href="#cb27-77" tabindex="-1"></a>    answer_value <span class="op">=</span> <span class="bu">str</span>(parsed.get(<span class="st">"answer_value"</span>, <span class="st">""</span>)).strip() <span class="kw">or</span> <span class="st">"is_blank"</span></span>
<span id="cb27-78"><a href="#cb27-78" tabindex="-1"></a>    answer_value <span class="op">=</span> normalize_answer_value(</span>
<span id="cb27-79"><a href="#cb27-79" tabindex="-1"></a>        raw_answer_value<span class="op">=</span>answer_value,</span>
<span id="cb27-80"><a href="#cb27-80" tabindex="-1"></a>        answer_text<span class="op">=</span>answer,</span>
<span id="cb27-81"><a href="#cb27-81" tabindex="-1"></a>        answer_unit<span class="op">=</span>answer_unit,</span>
<span id="cb27-82"><a href="#cb27-82" tabindex="-1"></a>        is_blank<span class="op">=</span>is_blank,</span>
<span id="cb27-83"><a href="#cb27-83" tabindex="-1"></a>    )</span>
<span id="cb27-84"><a href="#cb27-84" tabindex="-1"></a>    supporting_materials <span class="op">=</span> <span class="bu">str</span>(parsed.get(<span class="st">"supporting_materials"</span>, <span class="st">""</span>)).strip()</span>
<span id="cb27-85"><a href="#cb27-85" tabindex="-1"></a></span>
<span id="cb27-86"><a href="#cb27-86" tabindex="-1"></a>    <span class="co"># If context is empty or model says blank, force is_blank behaviour</span></span>
<span id="cb27-87"><a href="#cb27-87" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> context.strip() <span class="kw">or</span> is_blank:</span>
<span id="cb27-88"><a href="#cb27-88" tabindex="-1"></a>        is_blank <span class="op">=</span> <span class="va">True</span></span>
<span id="cb27-89"><a href="#cb27-89" tabindex="-1"></a>        answer <span class="op">=</span> <span class="st">""</span></span>
<span id="cb27-90"><a href="#cb27-90" tabindex="-1"></a>        answer_value <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb27-91"><a href="#cb27-91" tabindex="-1"></a>        ref_ids <span class="op">=</span> []</span>
<span id="cb27-92"><a href="#cb27-92" tabindex="-1"></a>        supporting_materials <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb27-93"><a href="#cb27-93" tabindex="-1"></a></span>
<span id="cb27-94"><a href="#cb27-94" tabindex="-1"></a>    <span class="co"># String formatting for ref_id / ref_url to match training style</span></span>
<span id="cb27-95"><a href="#cb27-95" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> ref_ids:</span>
<span id="cb27-96"><a href="#cb27-96" tabindex="-1"></a>        ref_id_str <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb27-97"><a href="#cb27-97" tabindex="-1"></a>        ref_url_str <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb27-98"><a href="#cb27-98" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb27-99"><a href="#cb27-99" tabindex="-1"></a>        ref_id_str <span class="op">=</span> <span class="bu">str</span>(ref_ids)</span>
<span id="cb27-100"><a href="#cb27-100" tabindex="-1"></a></span>
<span id="cb27-101"><a href="#cb27-101" tabindex="-1"></a>        <span class="co"># Resolve ref_url via metadata</span></span>
<span id="cb27-102"><a href="#cb27-102" tabindex="-1"></a>        ref_url <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb27-103"><a href="#cb27-103" tabindex="-1"></a>        <span class="cf">for</span> rid <span class="kw">in</span> ref_ids:</span>
<span id="cb27-104"><a href="#cb27-104" tabindex="-1"></a>            <span class="cf">if</span> rid <span class="kw">in</span> docid_to_url:</span>
<span id="cb27-105"><a href="#cb27-105" tabindex="-1"></a>                ref_url <span class="op">=</span> docid_to_url[rid]</span>
<span id="cb27-106"><a href="#cb27-106" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb27-107"><a href="#cb27-107" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> ref_url:</span>
<span id="cb27-108"><a href="#cb27-108" tabindex="-1"></a>            ref_url <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb27-109"><a href="#cb27-109" tabindex="-1"></a>        ref_url_str <span class="op">=</span> <span class="bu">str</span>([ref_url])</span>
<span id="cb27-110"><a href="#cb27-110" tabindex="-1"></a></span>
<span id="cb27-111"><a href="#cb27-111" tabindex="-1"></a>    <span class="cf">return</span> answer, answer_value, is_blank, ref_ids, supporting_materials, ref_id_str, ref_url_str</span>
<span id="cb27-112"><a href="#cb27-112" tabindex="-1"></a></span>
<span id="cb27-113"><a href="#cb27-113" tabindex="-1"></a></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="second-llm-step-explanation-and-evidence-type">Second LLM Step: Explanation and Evidence Type<a class="anchor" aria-label="anchor" href="#second-llm-step-explanation-and-evidence-type"></a></h3>
<p>Now that we have an answer, we produce a short explanation and
classify the evidence type. This step matches WattBot’s expected
metadata.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="kw">def</span> explanation_phase_for_question(question, answer, supporting_materials, ref_ids, is_blank):</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="co">    Second LLM call: ask Qwen to label an evidence_type and provide a short</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="co">    explanation tying the answer back to the supporting materials.</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>    <span class="cf">if</span> is_blank:</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>        <span class="co"># For unanswerable questions we just propagate a sentinel.</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>        evidence_type <span class="op">=</span> <span class="st">"other"</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>        explanation <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>        <span class="cf">return</span> evidence_type, explanation</span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>    expl_user_prompt <span class="op">=</span> build_explanation_prompt(</span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>        question<span class="op">=</span>question,</span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a>        answer<span class="op">=</span>answer,</span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a>        supporting_materials<span class="op">=</span>supporting_materials,</span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a>        ref_id_list<span class="op">=</span>ref_ids,</span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a>    )</span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a>    raw_expl <span class="op">=</span> call_qwen_chat(</span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a>        explanation_system_prompt,</span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a>        expl_user_prompt,</span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a>        max_new_tokens<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a>    )</span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a>    <span class="co"># Take the first non-empty line (we expect something like "text: short reason")</span></span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a>    first_line <span class="op">=</span> <span class="st">""</span></span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> raw_expl.splitlines():</span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a>        <span class="cf">if</span> line.strip():</span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a>            first_line <span class="op">=</span> line.strip()</span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">":"</span> <span class="kw">in</span> first_line:</span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a>        etype, expl <span class="op">=</span> first_line.split(<span class="st">":"</span>, <span class="dv">1</span>)</span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a>        evidence_type <span class="op">=</span> etype.strip().lower() <span class="kw">or</span> <span class="st">"other"</span></span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a>        explanation <span class="op">=</span> expl.strip()</span>
<span id="cb28-35"><a href="#cb28-35" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb28-36"><a href="#cb28-36" tabindex="-1"></a>        evidence_type <span class="op">=</span> <span class="st">"other"</span></span>
<span id="cb28-37"><a href="#cb28-37" tabindex="-1"></a>        explanation <span class="op">=</span> first_line.strip() <span class="kw">or</span> <span class="st">"short justification"</span></span>
<span id="cb28-38"><a href="#cb28-38" tabindex="-1"></a></span>
<span id="cb28-39"><a href="#cb28-39" tabindex="-1"></a>    <span class="co"># Keep explanations short for the CSV</span></span>
<span id="cb28-40"><a href="#cb28-40" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(explanation) <span class="op">&gt;</span> <span class="dv">100</span>:</span>
<span id="cb28-41"><a href="#cb28-41" tabindex="-1"></a>        explanation <span class="op">=</span> explanation[:<span class="dv">100</span>]</span>
<span id="cb28-42"><a href="#cb28-42" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" tabindex="-1"></a>    <span class="cf">return</span> evidence_type, explanation</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="orchestration-run_single_qa">Orchestration: <code>run_single_qa</code>
<a class="anchor" aria-label="anchor" href="#orchestration-run_single_qa"></a></h3>
<p>This high‐level function ties together retrieval, answering,
normalization, and explanation into one full pass over a single
question.</p>
</div>
<div class="section level3">
<h3 id="handling-unanswerable-questions">Handling unanswerable questions<a class="anchor" aria-label="anchor" href="#handling-unanswerable-questions"></a></h3>
<p>Some WattBot questions truly <strong>cannot</strong> be answered from
the retrieved papers.<br>
We use a simple hybrid rule to detect these cases:</p>
<ul><li>We look at the <strong>top retrieval score</strong> (cosine
similarity).<br></li>
<li>We also use the LLM’s own <code>is_blank</code> flag from the first
JSON response.</li>
</ul><p>If <strong>either</strong> of these says the evidence is too weak, we
mark the question as unanswerable and set all relevant fields
(<code>answer_value</code>, <code>ref_id</code>,
<code>supporting_materials</code>) to <code>is_blank</code>.</p>
<p>The <code>THRESHOLD</code> inside <code>run_single_qa</code> controls
how strict this behaviour is:</p>
<ul><li>lower values → fewer questions marked unanswerable<br></li>
<li>higher values → more questions marked unanswerable</li>
</ul><p>You can change <code>THRESHOLD</code> and then re-run the notebook
and <code>Score.py</code> to see how this trade-off affects your final
WattBot score.</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="kw">def</span> run_single_qa(</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>    row,</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>    embedder,</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>    chunk_embeddings,</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>    chunked_docs,</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>    top_k: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>,</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>):</span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>    <span class="co">"""Run retrieval + Qwen for a single training QA row.</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a><span class="co">    This is the high-level orchestration function that calls three helpers:</span></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a><span class="co">    1. retrieve_context_for_question  -&gt; get relevant text chunks</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a><span class="co">    2. answer_phase_for_question      -&gt; generate answer from context, returning citations and supporting materials</span></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a><span class="co">    3. explanation_phase_for_question -&gt; evidence type + short explanation</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a>    <span class="co"># Confidence threshold for retrieval.</span></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a>    <span class="co"># If the top similarity score is below this value, we treat the question</span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>    <span class="co"># as unanswerable, even if the LLM tried to produce an answer.</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a>    THRESHOLD <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a>    qid <span class="op">=</span> row[<span class="st">"id"</span>]</span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a>    question <span class="op">=</span> row[<span class="st">"question"</span>]</span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a>    answer_unit <span class="op">=</span> row.get(<span class="st">"answer_unit"</span>, <span class="st">""</span>)</span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a>    <span class="co"># 1. Retrieval step</span></span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a>    retrieved, context <span class="op">=</span> retrieve_context_for_question(</span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a>        question<span class="op">=</span>question,</span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a>        embedder<span class="op">=</span>embedder,</span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a>        chunk_embeddings<span class="op">=</span>chunk_embeddings,</span>
<span id="cb29-32"><a href="#cb29-32" tabindex="-1"></a>        chunked_docs<span class="op">=</span>chunked_docs,</span>
<span id="cb29-33"><a href="#cb29-33" tabindex="-1"></a>        top_k<span class="op">=</span>top_k,</span>
<span id="cb29-34"><a href="#cb29-34" tabindex="-1"></a>    )</span>
<span id="cb29-35"><a href="#cb29-35" tabindex="-1"></a></span>
<span id="cb29-36"><a href="#cb29-36" tabindex="-1"></a>    top_score <span class="op">=</span> retrieved[<span class="dv">0</span>][<span class="st">"score"</span>] <span class="cf">if</span> retrieved <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb29-37"><a href="#cb29-37" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" tabindex="-1"></a>    <span class="co"># 2. Answer + refs + supporting materials (LLM's view)</span></span>
<span id="cb29-39"><a href="#cb29-39" tabindex="-1"></a>    (</span>
<span id="cb29-40"><a href="#cb29-40" tabindex="-1"></a>        answer,</span>
<span id="cb29-41"><a href="#cb29-41" tabindex="-1"></a>        answer_value,</span>
<span id="cb29-42"><a href="#cb29-42" tabindex="-1"></a>        is_blank_llm,</span>
<span id="cb29-43"><a href="#cb29-43" tabindex="-1"></a>        ref_ids,</span>
<span id="cb29-44"><a href="#cb29-44" tabindex="-1"></a>        supporting_materials,</span>
<span id="cb29-45"><a href="#cb29-45" tabindex="-1"></a>        ref_id_str,</span>
<span id="cb29-46"><a href="#cb29-46" tabindex="-1"></a>        ref_url_str,</span>
<span id="cb29-47"><a href="#cb29-47" tabindex="-1"></a>    ) <span class="op">=</span> answer_phase_for_question(</span>
<span id="cb29-48"><a href="#cb29-48" tabindex="-1"></a>        qid<span class="op">=</span>qid,</span>
<span id="cb29-49"><a href="#cb29-49" tabindex="-1"></a>        question<span class="op">=</span>question,</span>
<span id="cb29-50"><a href="#cb29-50" tabindex="-1"></a>        answer_unit<span class="op">=</span>answer_unit,</span>
<span id="cb29-51"><a href="#cb29-51" tabindex="-1"></a>        context<span class="op">=</span>context,</span>
<span id="cb29-52"><a href="#cb29-52" tabindex="-1"></a>    )</span>
<span id="cb29-53"><a href="#cb29-53" tabindex="-1"></a></span>
<span id="cb29-54"><a href="#cb29-54" tabindex="-1"></a>    <span class="co"># Hybrid is_blank decision:</span></span>
<span id="cb29-55"><a href="#cb29-55" tabindex="-1"></a>    <span class="co"># - if retrieval is weak (top_score &lt; THRESHOLD)</span></span>
<span id="cb29-56"><a href="#cb29-56" tabindex="-1"></a>    <span class="co"># - OR the LLM marks is_blank = true</span></span>
<span id="cb29-57"><a href="#cb29-57" tabindex="-1"></a>    <span class="co"># then we treat the question as unanswerable.</span></span>
<span id="cb29-58"><a href="#cb29-58" tabindex="-1"></a>    is_blank <span class="op">=</span> <span class="bu">bool</span>(is_blank_llm) <span class="kw">or</span> (top_score <span class="op">&lt;</span> THRESHOLD)</span>
<span id="cb29-59"><a href="#cb29-59" tabindex="-1"></a></span>
<span id="cb29-60"><a href="#cb29-60" tabindex="-1"></a>    <span class="cf">if</span> is_blank:</span>
<span id="cb29-61"><a href="#cb29-61" tabindex="-1"></a>        answer <span class="op">=</span> <span class="st">""</span></span>
<span id="cb29-62"><a href="#cb29-62" tabindex="-1"></a>        answer_value <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb29-63"><a href="#cb29-63" tabindex="-1"></a>        ref_ids <span class="op">=</span> []</span>
<span id="cb29-64"><a href="#cb29-64" tabindex="-1"></a>        ref_id_str <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb29-65"><a href="#cb29-65" tabindex="-1"></a>        ref_url_str <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb29-66"><a href="#cb29-66" tabindex="-1"></a>        supporting_materials <span class="op">=</span> <span class="st">"is_blank"</span></span>
<span id="cb29-67"><a href="#cb29-67" tabindex="-1"></a></span>
<span id="cb29-68"><a href="#cb29-68" tabindex="-1"></a>    <span class="co"># Always copy answer_unit from train_QA.csv (do NOT let the LLM invent it)</span></span>
<span id="cb29-69"><a href="#cb29-69" tabindex="-1"></a>    answer_unit <span class="op">=</span> row.get(<span class="st">"answer_unit"</span>, <span class="st">""</span>)</span>
<span id="cb29-70"><a href="#cb29-70" tabindex="-1"></a></span>
<span id="cb29-71"><a href="#cb29-71" tabindex="-1"></a>    <span class="co"># 3. Explanation + evidence_type</span></span>
<span id="cb29-72"><a href="#cb29-72" tabindex="-1"></a>    evidence_type, explanation <span class="op">=</span> explanation_phase_for_question(</span>
<span id="cb29-73"><a href="#cb29-73" tabindex="-1"></a>        question<span class="op">=</span>question,</span>
<span id="cb29-74"><a href="#cb29-74" tabindex="-1"></a>        answer<span class="op">=</span>answer,</span>
<span id="cb29-75"><a href="#cb29-75" tabindex="-1"></a>        supporting_materials<span class="op">=</span>supporting_materials,</span>
<span id="cb29-76"><a href="#cb29-76" tabindex="-1"></a>        ref_ids<span class="op">=</span>ref_ids,</span>
<span id="cb29-77"><a href="#cb29-77" tabindex="-1"></a>        is_blank<span class="op">=</span>is_blank,</span>
<span id="cb29-78"><a href="#cb29-78" tabindex="-1"></a>    )</span>
<span id="cb29-79"><a href="#cb29-79" tabindex="-1"></a></span>
<span id="cb29-80"><a href="#cb29-80" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb29-81"><a href="#cb29-81" tabindex="-1"></a>        <span class="st">"id"</span>: qid,</span>
<span id="cb29-82"><a href="#cb29-82" tabindex="-1"></a>        <span class="st">"question"</span>: question,</span>
<span id="cb29-83"><a href="#cb29-83" tabindex="-1"></a>        <span class="st">"answer"</span>: answer,</span>
<span id="cb29-84"><a href="#cb29-84" tabindex="-1"></a>        <span class="st">"answer_value"</span>: answer_value,</span>
<span id="cb29-85"><a href="#cb29-85" tabindex="-1"></a>        <span class="st">"answer_unit"</span>: answer_unit,</span>
<span id="cb29-86"><a href="#cb29-86" tabindex="-1"></a>        <span class="st">"is_blank"</span>: <span class="st">"true"</span> <span class="cf">if</span> is_blank <span class="cf">else</span> <span class="st">"false"</span>,</span>
<span id="cb29-87"><a href="#cb29-87" tabindex="-1"></a>        <span class="st">"ref_id"</span>: ref_id_str,</span>
<span id="cb29-88"><a href="#cb29-88" tabindex="-1"></a>        <span class="st">"ref_url"</span>: ref_url_str,</span>
<span id="cb29-89"><a href="#cb29-89" tabindex="-1"></a>        <span class="st">"supporting_materials"</span>: supporting_materials,</span>
<span id="cb29-90"><a href="#cb29-90" tabindex="-1"></a>        <span class="st">"evidence_type"</span>: evidence_type,</span>
<span id="cb29-91"><a href="#cb29-91" tabindex="-1"></a>        <span class="st">"explanation"</span>: explanation,</span>
<span id="cb29-92"><a href="#cb29-92" tabindex="-1"></a>    }</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="co"># Run over max_N training questions (this can take a while!)</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>all_results <span class="op">=</span> []</span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>error_log <span class="op">=</span> []</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>max_N <span class="op">=</span> np.inf</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> train_df.iterrows():</span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>    <span class="cf">if</span> idx <span class="op">&gt;=</span> max_N:</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>    question <span class="op">=</span> row[<span class="st">"question"</span>]</span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"########################################################################################################</span><span class="ch">\n</span><span class="ss">QUESTION: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>    res <span class="op">=</span> run_single_qa(</span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>        row<span class="op">=</span>row,</span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>        embedder<span class="op">=</span>embedder,</span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>        chunk_embeddings<span class="op">=</span>chunk_embeddings,</span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>        chunked_docs<span class="op">=</span>chunked_docs,</span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a>        top_k<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb30-20"><a href="#cb30-20" tabindex="-1"></a>    )</span>
<span id="cb30-21"><a href="#cb30-21" tabindex="-1"></a>    answer <span class="op">=</span> res[<span class="st">"answer"</span>]</span>
<span id="cb30-22"><a href="#cb30-22" tabindex="-1"></a>    ref_ids <span class="op">=</span> res[<span class="st">"ref_id"</span>]</span>
<span id="cb30-23"><a href="#cb30-23" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" tabindex="-1"></a>    explanation <span class="op">=</span> res[<span class="st">"explanation"</span>]</span>
<span id="cb30-25"><a href="#cb30-25" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"ANSWER: </span><span class="sc">{</span>answer<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-26"><a href="#cb30-26" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"ref_ids: </span><span class="sc">{</span>ref_ids<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-27"><a href="#cb30-27" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"EXPLANATION: </span><span class="sc">{</span>explanation<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-28"><a href="#cb30-28" tabindex="-1"></a>    </span>
<span id="cb30-29"><a href="#cb30-29" tabindex="-1"></a>    all_results.append(res)</span>
<span id="cb30-30"><a href="#cb30-30" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" tabindex="-1"></a>solutions_df <span class="op">=</span> pd.DataFrame(all_results)</span>
<span id="cb30-32"><a href="#cb30-32" tabindex="-1"></a>solutions_path <span class="op">=</span> os.path.join(local_data_dir, <span class="st">"train_solutions_qwen.csv"</span>)</span>
<span id="cb30-33"><a href="#cb30-33" tabindex="-1"></a>solutions_df.to_csv(solutions_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-34"><a href="#cb30-34" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved solutions for </span><span class="sc">{</span><span class="bu">len</span>(solutions_df)<span class="sc">}</span><span class="ss"> questions to: </span><span class="sc">{</span>solutions_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-36"><a href="#cb30-36" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of questions with errors (filled as blank): </span><span class="sc">{</span><span class="bu">len</span>(error_log)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-37"><a href="#cb30-37" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" tabindex="-1"></a>solutions_df.head(<span class="dv">20</span>)</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="compare-answers-to-ground-truth">Compare answers to ground truth<a class="anchor" aria-label="anchor" href="#compare-answers-to-ground-truth"></a></h3>
<p>WattBot evaluates each prediction using a weighted score that
combines three components. Most of the credit (0.75) comes from the
<code>answer_value</code>, which must match the ground truth after
normalization (numeric answers must be within ±0.1% relative tolerance;
categorical values must match exactly). An additional 0.15 comes from
<code>ref_id</code>, where partial credit is given based on the Jaccard
overlap between your cited document IDs and the ground-truth set. The
final 0.10 comes from correctly marking unanswerable questions: if a
question is truly unanswerable, you must set <code>answer_value</code>,
<code>ref_id</code>, and <code>supporting_materials</code> to
<code>is_blank</code>. Any other combination scores zero for this
component.</p>
<table class="table"><colgroup><col width="33%"><col width="16%"><col width="50%"></colgroup><thead><tr class="header"><th>Component</th>
<th>Weight</th>
<th>What counts as correct</th>
</tr></thead><tbody><tr class="odd"><td>answer_value</td>
<td>0.75</td>
<td>Numeric within ±0.1% relative tolerance; categorical exact match;
<code>is_blank</code> if unanswerable</td>
</tr><tr class="even"><td>ref_id</td>
<td>0.15</td>
<td>Jaccard overlap with the ground-truth reference set
(case-insensitive)</td>
</tr><tr class="odd"><td>is_NA</td>
<td>0.10</td>
<td>All required fields set to <code>is_blank</code> when the question
is truly unanswerable</td>
</tr></tbody></table><div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="kw">def</span> _to_bool_flag(x):</span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>    <span class="co">"""Convert typical truthy/falsey strings to bool."""</span></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">str</span>):</span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>        s <span class="op">=</span> x.strip().lower()</span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>        <span class="cf">if</span> s <span class="kw">in</span> {<span class="st">"1"</span>, <span class="st">"True"</span>, <span class="st">"true"</span>, <span class="st">"yes"</span>}:</span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>        <span class="cf">if</span> s <span class="kw">in</span> {<span class="st">"0"</span>, <span class="st">"False"</span>, <span class="st">"false"</span>, <span class="st">"no"</span>}:</span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">bool</span>(x)</span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a><span class="kw">def</span> _parse_float_or_none(x):</span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(<span class="bu">str</span>(x).strip())</span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb31-19"><a href="#cb31-19" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" tabindex="-1"></a><span class="kw">def</span> _answer_value_correct(gt_val, pred_val, rel_tol<span class="op">=</span><span class="fl">1e-3</span>):</span>
<span id="cb31-21"><a href="#cb31-21" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-22"><a href="#cb31-22" tabindex="-1"></a><span class="co">    gt_val, pred_val: values from answer_value columns.</span></span>
<span id="cb31-23"><a href="#cb31-23" tabindex="-1"></a><span class="co">    rel_tol = 0.001 =&gt; 0.1% relative tolerance.</span></span>
<span id="cb31-24"><a href="#cb31-24" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-25"><a href="#cb31-25" tabindex="-1"></a>    gt_str <span class="op">=</span> <span class="bu">str</span>(gt_val).strip()</span>
<span id="cb31-26"><a href="#cb31-26" tabindex="-1"></a>    pred_str <span class="op">=</span> <span class="bu">str</span>(pred_val).strip()</span>
<span id="cb31-27"><a href="#cb31-27" tabindex="-1"></a>    </span>
<span id="cb31-28"><a href="#cb31-28" tabindex="-1"></a>    <span class="co"># If either is 'is_blank', treat as categorical</span></span>
<span id="cb31-29"><a href="#cb31-29" tabindex="-1"></a>    <span class="cf">if</span> gt_str.lower() <span class="op">==</span> <span class="st">"is_blank"</span> <span class="kw">or</span> pred_str.lower() <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb31-30"><a href="#cb31-30" tabindex="-1"></a>        <span class="cf">return</span> gt_str.lower() <span class="op">==</span> pred_str.lower()</span>
<span id="cb31-31"><a href="#cb31-31" tabindex="-1"></a>    </span>
<span id="cb31-32"><a href="#cb31-32" tabindex="-1"></a>    gt_num <span class="op">=</span> _parse_float_or_none(gt_val)</span>
<span id="cb31-33"><a href="#cb31-33" tabindex="-1"></a>    pred_num <span class="op">=</span> _parse_float_or_none(pred_val)</span>
<span id="cb31-34"><a href="#cb31-34" tabindex="-1"></a>    </span>
<span id="cb31-35"><a href="#cb31-35" tabindex="-1"></a>    <span class="co"># If both numeric, use relative tolerance</span></span>
<span id="cb31-36"><a href="#cb31-36" tabindex="-1"></a>    <span class="cf">if</span> gt_num <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> pred_num <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb31-37"><a href="#cb31-37" tabindex="-1"></a>        <span class="cf">if</span> gt_num <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb31-38"><a href="#cb31-38" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">abs</span>(pred_num <span class="op">-</span> gt_num) <span class="op">&lt;=</span> rel_tol  <span class="co"># small absolute tolerance around 0</span></span>
<span id="cb31-39"><a href="#cb31-39" tabindex="-1"></a>        rel_err <span class="op">=</span> <span class="bu">abs</span>(pred_num <span class="op">-</span> gt_num) <span class="op">/</span> <span class="bu">max</span>(<span class="bu">abs</span>(gt_num), <span class="fl">1e-12</span>)</span>
<span id="cb31-40"><a href="#cb31-40" tabindex="-1"></a>        <span class="cf">return</span> rel_err <span class="op">&lt;=</span> rel_tol</span>
<span id="cb31-41"><a href="#cb31-41" tabindex="-1"></a>    </span>
<span id="cb31-42"><a href="#cb31-42" tabindex="-1"></a>    <span class="co"># Otherwise, fall back to normalized string match</span></span>
<span id="cb31-43"><a href="#cb31-43" tabindex="-1"></a>    <span class="cf">return</span> gt_str.lower() <span class="op">==</span> pred_str.lower()</span>
<span id="cb31-44"><a href="#cb31-44" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" tabindex="-1"></a><span class="kw">def</span> _ref_id_jaccard(gt_ref, pred_ref):</span>
<span id="cb31-46"><a href="#cb31-46" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-47"><a href="#cb31-47" tabindex="-1"></a><span class="co">    Jaccard overlap between sets of ref_ids.</span></span>
<span id="cb31-48"><a href="#cb31-48" tabindex="-1"></a><span class="co">    Strings may contain semicolon-separated IDs, or 'is_blank'.</span></span>
<span id="cb31-49"><a href="#cb31-49" tabindex="-1"></a><span class="co">    Case-insensitive.</span></span>
<span id="cb31-50"><a href="#cb31-50" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-51"><a href="#cb31-51" tabindex="-1"></a>    <span class="kw">def</span> to_set(s):</span>
<span id="cb31-52"><a href="#cb31-52" tabindex="-1"></a>        <span class="cf">if</span> s <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-53"><a href="#cb31-53" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">set</span>()</span>
<span id="cb31-54"><a href="#cb31-54" tabindex="-1"></a>        s <span class="op">=</span> <span class="bu">str</span>(s).strip()</span>
<span id="cb31-55"><a href="#cb31-55" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> s <span class="kw">or</span> s.lower() <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb31-56"><a href="#cb31-56" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">set</span>()</span>
<span id="cb31-57"><a href="#cb31-57" tabindex="-1"></a>        parts <span class="op">=</span> [p.strip().lower() <span class="cf">for</span> p <span class="kw">in</span> s.split(<span class="st">";"</span>) <span class="cf">if</span> p.strip()]</span>
<span id="cb31-58"><a href="#cb31-58" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">set</span>(parts)</span>
<span id="cb31-59"><a href="#cb31-59" tabindex="-1"></a>    </span>
<span id="cb31-60"><a href="#cb31-60" tabindex="-1"></a>    gt_set <span class="op">=</span> to_set(gt_ref)</span>
<span id="cb31-61"><a href="#cb31-61" tabindex="-1"></a>    pred_set <span class="op">=</span> to_set(pred_ref)</span>
<span id="cb31-62"><a href="#cb31-62" tabindex="-1"></a>    </span>
<span id="cb31-63"><a href="#cb31-63" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gt_set <span class="kw">and</span> <span class="kw">not</span> pred_set:</span>
<span id="cb31-64"><a href="#cb31-64" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span></span>
<span id="cb31-65"><a href="#cb31-65" tabindex="-1"></a>    union <span class="op">=</span> gt_set <span class="op">|</span> pred_set</span>
<span id="cb31-66"><a href="#cb31-66" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> union:</span>
<span id="cb31-67"><a href="#cb31-67" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb31-68"><a href="#cb31-68" tabindex="-1"></a>    inter <span class="op">=</span> gt_set <span class="op">&amp;</span> pred_set</span>
<span id="cb31-69"><a href="#cb31-69" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">len</span>(inter) <span class="op">/</span> <span class="bu">len</span>(union)</span>
<span id="cb31-70"><a href="#cb31-70" tabindex="-1"></a></span>
<span id="cb31-71"><a href="#cb31-71" tabindex="-1"></a><span class="kw">def</span> compute_wattbot_score(</span>
<span id="cb31-72"><a href="#cb31-72" tabindex="-1"></a>    train_qa_path<span class="op">=</span><span class="st">"train_QA.csv"</span>,</span>
<span id="cb31-73"><a href="#cb31-73" tabindex="-1"></a>    preds_path<span class="op">=</span><span class="st">"train_solutions_qwen.csv"</span>,</span>
<span id="cb31-74"><a href="#cb31-74" tabindex="-1"></a>    id_col<span class="op">=</span><span class="st">"id"</span>,</span>
<span id="cb31-75"><a href="#cb31-75" tabindex="-1"></a>    gt_answer_col<span class="op">=</span><span class="st">"answer_value"</span>,</span>
<span id="cb31-76"><a href="#cb31-76" tabindex="-1"></a>    gt_ref_col<span class="op">=</span><span class="st">"ref_id"</span>,</span>
<span id="cb31-77"><a href="#cb31-77" tabindex="-1"></a>    gt_is_na_col<span class="op">=</span><span class="st">"is_NA"</span>,   <span class="co"># can also pass "is_blank" or None</span></span>
<span id="cb31-78"><a href="#cb31-78" tabindex="-1"></a>    pred_answer_col<span class="op">=</span><span class="st">"answer_value"</span>,</span>
<span id="cb31-79"><a href="#cb31-79" tabindex="-1"></a>    pred_ref_col<span class="op">=</span><span class="st">"ref_id"</span>,</span>
<span id="cb31-80"><a href="#cb31-80" tabindex="-1"></a>    pred_is_na_col<span class="op">=</span><span class="va">None</span>,    <span class="co"># can pass "is_blank", or leave None to auto</span></span>
<span id="cb31-81"><a href="#cb31-81" tabindex="-1"></a>    n_examples<span class="op">=</span><span class="dv">10</span>,          <span class="co"># how many incorrect examples to print</span></span>
<span id="cb31-82"><a href="#cb31-82" tabindex="-1"></a>):</span>
<span id="cb31-83"><a href="#cb31-83" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-84"><a href="#cb31-84" tabindex="-1"></a><span class="co">    Compare your solutions to train_QA.csv using a WattBot-style score.</span></span>
<span id="cb31-85"><a href="#cb31-85" tabindex="-1"></a></span>
<span id="cb31-86"><a href="#cb31-86" tabindex="-1"></a><span class="co">    NA logic:</span></span>
<span id="cb31-87"><a href="#cb31-87" tabindex="-1"></a><span class="co">    - If an explicit NA column is found/used (e.g. is_NA), we use it via _to_bool_flag.</span></span>
<span id="cb31-88"><a href="#cb31-88" tabindex="-1"></a><span class="co">    - If you pass gt_is_na_col="is_blank" or pred_is_na_col="is_blank",</span></span>
<span id="cb31-89"><a href="#cb31-89" tabindex="-1"></a><span class="co">      we *derive* NA from answer_value == "is_blank" instead of expecting a real column.</span></span>
<span id="cb31-90"><a href="#cb31-90" tabindex="-1"></a><span class="co">    - If no NA column is available at all, we derive from answer_value == "is_blank".</span></span>
<span id="cb31-91"><a href="#cb31-91" tabindex="-1"></a></span>
<span id="cb31-92"><a href="#cb31-92" tabindex="-1"></a><span class="co">    Also prints up to `n_examples` rows where the model is not perfect</span></span>
<span id="cb31-93"><a href="#cb31-93" tabindex="-1"></a><span class="co">    (answer_score &lt; 1, ref_id_score &lt; 1, or is_NA_score &lt; 1).</span></span>
<span id="cb31-94"><a href="#cb31-94" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-95"><a href="#cb31-95" tabindex="-1"></a>    gt <span class="op">=</span> pd.read_csv(train_qa_path)</span>
<span id="cb31-96"><a href="#cb31-96" tabindex="-1"></a>    preds <span class="op">=</span> pd.read_csv(preds_path)</span>
<span id="cb31-97"><a href="#cb31-97" tabindex="-1"></a>    </span>
<span id="cb31-98"><a href="#cb31-98" tabindex="-1"></a>    <span class="co"># Inner join on id to be strict</span></span>
<span id="cb31-99"><a href="#cb31-99" tabindex="-1"></a>    merged <span class="op">=</span> gt.merge(preds, on<span class="op">=</span>id_col, suffixes<span class="op">=</span>(<span class="st">"_gt"</span>, <span class="st">"_pred"</span>))</span>
<span id="cb31-100"><a href="#cb31-100" tabindex="-1"></a>    <span class="cf">if</span> merged.empty:</span>
<span id="cb31-101"><a href="#cb31-101" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No overlapping ids between ground truth and predictions."</span>)</span>
<span id="cb31-102"><a href="#cb31-102" tabindex="-1"></a></span>
<span id="cb31-103"><a href="#cb31-103" tabindex="-1"></a>    <span class="co"># ----- ground truth NA flags -----</span></span>
<span id="cb31-104"><a href="#cb31-104" tabindex="-1"></a>    <span class="cf">if</span> gt_is_na_col <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> gt_is_na_col <span class="kw">in</span> merged.columns:</span>
<span id="cb31-105"><a href="#cb31-105" tabindex="-1"></a>        <span class="co"># Use explicit column (e.g. "is_NA")</span></span>
<span id="cb31-106"><a href="#cb31-106" tabindex="-1"></a>        gt_is_na_series <span class="op">=</span> merged[gt_is_na_col].<span class="bu">map</span>(_to_bool_flag)</span>
<span id="cb31-107"><a href="#cb31-107" tabindex="-1"></a>    <span class="cf">elif</span> gt_is_na_col <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> gt_is_na_col.lower() <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb31-108"><a href="#cb31-108" tabindex="-1"></a>        <span class="co"># Special meaning: derive NA from answer_value_gt == "is_blank"</span></span>
<span id="cb31-109"><a href="#cb31-109" tabindex="-1"></a>        gt_is_na_series <span class="op">=</span> merged[<span class="ss">f"</span><span class="sc">{</span>gt_answer_col<span class="sc">}</span><span class="ss">_gt"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower().eq(<span class="st">"is_blank"</span>)</span>
<span id="cb31-110"><a href="#cb31-110" tabindex="-1"></a>        merged[<span class="st">"gt_is_blank_flag"</span>] <span class="op">=</span> gt_is_na_series</span>
<span id="cb31-111"><a href="#cb31-111" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb31-112"><a href="#cb31-112" tabindex="-1"></a>        <span class="co"># Fallback: if we have is_NA or is_blank col, use it; else derive</span></span>
<span id="cb31-113"><a href="#cb31-113" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"is_NA"</span> <span class="kw">in</span> merged.columns:</span>
<span id="cb31-114"><a href="#cb31-114" tabindex="-1"></a>            gt_is_na_series <span class="op">=</span> merged[<span class="st">"is_NA"</span>].<span class="bu">map</span>(_to_bool_flag)</span>
<span id="cb31-115"><a href="#cb31-115" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">"is_blank"</span> <span class="kw">in</span> merged.columns:</span>
<span id="cb31-116"><a href="#cb31-116" tabindex="-1"></a>            gt_is_na_series <span class="op">=</span> merged[<span class="st">"is_blank"</span>].<span class="bu">map</span>(_to_bool_flag)</span>
<span id="cb31-117"><a href="#cb31-117" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-118"><a href="#cb31-118" tabindex="-1"></a>            gt_is_na_series <span class="op">=</span> merged[<span class="ss">f"</span><span class="sc">{</span>gt_answer_col<span class="sc">}</span><span class="ss">_gt"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower().eq(<span class="st">"is_blank"</span>)</span>
<span id="cb31-119"><a href="#cb31-119" tabindex="-1"></a>            merged[<span class="st">"gt_is_blank_flag"</span>] <span class="op">=</span> gt_is_na_series</span>
<span id="cb31-120"><a href="#cb31-120" tabindex="-1"></a></span>
<span id="cb31-121"><a href="#cb31-121" tabindex="-1"></a>    <span class="co"># ----- prediction NA flags -----</span></span>
<span id="cb31-122"><a href="#cb31-122" tabindex="-1"></a>    <span class="cf">if</span> pred_is_na_col <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> pred_is_na_col <span class="kw">in</span> merged.columns:</span>
<span id="cb31-123"><a href="#cb31-123" tabindex="-1"></a>        pred_is_na_series <span class="op">=</span> merged[pred_is_na_col].<span class="bu">map</span>(_to_bool_flag)</span>
<span id="cb31-124"><a href="#cb31-124" tabindex="-1"></a>    <span class="cf">elif</span> pred_is_na_col <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> pred_is_na_col.lower() <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb31-125"><a href="#cb31-125" tabindex="-1"></a>        <span class="co"># Same convention: derive from answer_value_pred</span></span>
<span id="cb31-126"><a href="#cb31-126" tabindex="-1"></a>        pred_is_na_series <span class="op">=</span> merged[<span class="ss">f"</span><span class="sc">{</span>pred_answer_col<span class="sc">}</span><span class="ss">_pred"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower().eq(<span class="st">"is_blank"</span>)</span>
<span id="cb31-127"><a href="#cb31-127" tabindex="-1"></a>        merged[<span class="st">"pred_is_blank_flag"</span>] <span class="op">=</span> pred_is_na_series</span>
<span id="cb31-128"><a href="#cb31-128" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb31-129"><a href="#cb31-129" tabindex="-1"></a>        <span class="co"># Auto-detect or derive if no NA column in preds</span></span>
<span id="cb31-130"><a href="#cb31-130" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"is_NA"</span> <span class="kw">in</span> merged.columns:</span>
<span id="cb31-131"><a href="#cb31-131" tabindex="-1"></a>            pred_is_na_series <span class="op">=</span> merged[<span class="st">"is_NA"</span>].<span class="bu">map</span>(_to_bool_flag)</span>
<span id="cb31-132"><a href="#cb31-132" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">"is_blank"</span> <span class="kw">in</span> merged.columns:</span>
<span id="cb31-133"><a href="#cb31-133" tabindex="-1"></a>            pred_is_na_series <span class="op">=</span> merged[<span class="st">"is_blank"</span>].<span class="bu">map</span>(_to_bool_flag)</span>
<span id="cb31-134"><a href="#cb31-134" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-135"><a href="#cb31-135" tabindex="-1"></a>            pred_is_na_series <span class="op">=</span> merged[<span class="ss">f"</span><span class="sc">{</span>pred_answer_col<span class="sc">}</span><span class="ss">_pred"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower().eq(<span class="st">"is_blank"</span>)</span>
<span id="cb31-136"><a href="#cb31-136" tabindex="-1"></a>            merged[<span class="st">"pred_is_blank_flag"</span>] <span class="op">=</span> pred_is_na_series</span>
<span id="cb31-137"><a href="#cb31-137" tabindex="-1"></a></span>
<span id="cb31-138"><a href="#cb31-138" tabindex="-1"></a>    ans_scores <span class="op">=</span> []</span>
<span id="cb31-139"><a href="#cb31-139" tabindex="-1"></a>    ref_scores <span class="op">=</span> []</span>
<span id="cb31-140"><a href="#cb31-140" tabindex="-1"></a>    na_scores <span class="op">=</span> []</span>
<span id="cb31-141"><a href="#cb31-141" tabindex="-1"></a>    </span>
<span id="cb31-142"><a href="#cb31-142" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> merged.iterrows():</span>
<span id="cb31-143"><a href="#cb31-143" tabindex="-1"></a>        gt_ans <span class="op">=</span> row[<span class="ss">f"</span><span class="sc">{</span>gt_answer_col<span class="sc">}</span><span class="ss">_gt"</span>]</span>
<span id="cb31-144"><a href="#cb31-144" tabindex="-1"></a>        pred_ans <span class="op">=</span> row[<span class="ss">f"</span><span class="sc">{</span>pred_answer_col<span class="sc">}</span><span class="ss">_pred"</span>]</span>
<span id="cb31-145"><a href="#cb31-145" tabindex="-1"></a>        gt_ref <span class="op">=</span> row[<span class="ss">f"</span><span class="sc">{</span>gt_ref_col<span class="sc">}</span><span class="ss">_gt"</span>]</span>
<span id="cb31-146"><a href="#cb31-146" tabindex="-1"></a>        pred_ref <span class="op">=</span> row[<span class="ss">f"</span><span class="sc">{</span>pred_ref_col<span class="sc">}</span><span class="ss">_pred"</span>]</span>
<span id="cb31-147"><a href="#cb31-147" tabindex="-1"></a>        </span>
<span id="cb31-148"><a href="#cb31-148" tabindex="-1"></a>        gt_is_na <span class="op">=</span> <span class="bu">bool</span>(gt_is_na_series.iloc[idx])</span>
<span id="cb31-149"><a href="#cb31-149" tabindex="-1"></a>        pred_is_na <span class="op">=</span> <span class="bu">bool</span>(pred_is_na_series.iloc[idx])</span>
<span id="cb31-150"><a href="#cb31-150" tabindex="-1"></a>        </span>
<span id="cb31-151"><a href="#cb31-151" tabindex="-1"></a>        <span class="co"># 1. answer_value component</span></span>
<span id="cb31-152"><a href="#cb31-152" tabindex="-1"></a>        ans_correct <span class="op">=</span> _answer_value_correct(gt_ans, pred_ans)</span>
<span id="cb31-153"><a href="#cb31-153" tabindex="-1"></a>        ans_scores.append(<span class="fl">1.0</span> <span class="op">*</span> ans_correct)</span>
<span id="cb31-154"><a href="#cb31-154" tabindex="-1"></a>        </span>
<span id="cb31-155"><a href="#cb31-155" tabindex="-1"></a>        <span class="co"># 2. ref_id Jaccard</span></span>
<span id="cb31-156"><a href="#cb31-156" tabindex="-1"></a>        ref_j <span class="op">=</span> _ref_id_jaccard(gt_ref, pred_ref)</span>
<span id="cb31-157"><a href="#cb31-157" tabindex="-1"></a>        ref_scores.append(ref_j)</span>
<span id="cb31-158"><a href="#cb31-158" tabindex="-1"></a>        </span>
<span id="cb31-159"><a href="#cb31-159" tabindex="-1"></a>        <span class="co"># 3. is_NA component (simple: must match ground truth flag)</span></span>
<span id="cb31-160"><a href="#cb31-160" tabindex="-1"></a>        na_scores.append(<span class="fl">1.0</span> <span class="cf">if</span> gt_is_na <span class="op">==</span> pred_is_na <span class="cf">else</span> <span class="fl">0.0</span>)</span>
<span id="cb31-161"><a href="#cb31-161" tabindex="-1"></a>    </span>
<span id="cb31-162"><a href="#cb31-162" tabindex="-1"></a>    merged[<span class="st">"answer_score"</span>] <span class="op">=</span> ans_scores</span>
<span id="cb31-163"><a href="#cb31-163" tabindex="-1"></a>    merged[<span class="st">"ref_id_score"</span>] <span class="op">=</span> ref_scores</span>
<span id="cb31-164"><a href="#cb31-164" tabindex="-1"></a>    merged[<span class="st">"is_NA_score"</span>] <span class="op">=</span> na_scores</span>
<span id="cb31-165"><a href="#cb31-165" tabindex="-1"></a>    </span>
<span id="cb31-166"><a href="#cb31-166" tabindex="-1"></a>    merged[<span class="st">"wattbot_score"</span>] <span class="op">=</span> (</span>
<span id="cb31-167"><a href="#cb31-167" tabindex="-1"></a>        <span class="fl">0.75</span> <span class="op">*</span> merged[<span class="st">"answer_score"</span>]</span>
<span id="cb31-168"><a href="#cb31-168" tabindex="-1"></a>        <span class="op">+</span> <span class="fl">0.15</span> <span class="op">*</span> merged[<span class="st">"ref_id_score"</span>]</span>
<span id="cb31-169"><a href="#cb31-169" tabindex="-1"></a>        <span class="op">+</span> <span class="fl">0.10</span> <span class="op">*</span> merged[<span class="st">"is_NA_score"</span>]</span>
<span id="cb31-170"><a href="#cb31-170" tabindex="-1"></a>    )</span>
<span id="cb31-171"><a href="#cb31-171" tabindex="-1"></a>    </span>
<span id="cb31-172"><a href="#cb31-172" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Rows compared: </span><span class="sc">{</span><span class="bu">len</span>(merged)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-173"><a href="#cb31-173" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean answer_value score: </span><span class="sc">{</span>merged[<span class="st">'answer_score'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb31-174"><a href="#cb31-174" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean ref_id score:       </span><span class="sc">{</span>merged[<span class="st">'ref_id_score'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb31-175"><a href="#cb31-175" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean is_NA score:        </span><span class="sc">{</span>merged[<span class="st">'is_NA_score'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb31-176"><a href="#cb31-176" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Overall WattBot score:   </span><span class="sc">{</span>merged[<span class="st">'wattbot_score'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb31-177"><a href="#cb31-177" tabindex="-1"></a>    </span>
<span id="cb31-178"><a href="#cb31-178" tabindex="-1"></a>    <span class="co"># ----- Show some incorrect examples -----</span></span>
<span id="cb31-179"><a href="#cb31-179" tabindex="-1"></a>    incorrect <span class="op">=</span> merged[</span>
<span id="cb31-180"><a href="#cb31-180" tabindex="-1"></a>        (merged[<span class="st">"answer_score"</span>] <span class="op">&lt;</span> <span class="fl">1.0</span>)</span>
<span id="cb31-181"><a href="#cb31-181" tabindex="-1"></a>        <span class="op">|</span> (merged[<span class="st">"ref_id_score"</span>] <span class="op">&lt;</span> <span class="fl">1.0</span>)</span>
<span id="cb31-182"><a href="#cb31-182" tabindex="-1"></a>        <span class="op">|</span> (merged[<span class="st">"is_NA_score"</span>] <span class="op">&lt;</span> <span class="fl">1.0</span>)</span>
<span id="cb31-183"><a href="#cb31-183" tabindex="-1"></a>    ]</span>
<span id="cb31-184"><a href="#cb31-184" tabindex="-1"></a>    </span>
<span id="cb31-185"><a href="#cb31-185" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> incorrect.empty <span class="kw">and</span> n_examples <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-186"><a href="#cb31-186" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Examples of incorrect / partially correct responses "</span></span>
<span id="cb31-187"><a href="#cb31-187" tabindex="-1"></a>              <span class="ss">f"(up to </span><span class="sc">{</span>n_examples<span class="sc">}</span><span class="ss"> rows):</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb31-188"><a href="#cb31-188" tabindex="-1"></a>        <span class="co"># Grab up to n_examples "worst" rows by wattbot_score</span></span>
<span id="cb31-189"><a href="#cb31-189" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> incorrect.sort_values(<span class="st">"wattbot_score"</span>).head(n_examples).iterrows():</span>
<span id="cb31-190"><a href="#cb31-190" tabindex="-1"></a>            q <span class="op">=</span> row[<span class="st">"question_gt"</span>] <span class="cf">if</span> <span class="st">"question_gt"</span> <span class="kw">in</span> row.index <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb31-191"><a href="#cb31-191" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb31-192"><a href="#cb31-192" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"id: </span><span class="sc">{</span>row[id_col]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-193"><a href="#cb31-193" tabindex="-1"></a>            <span class="cf">if</span> q <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb31-194"><a href="#cb31-194" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>q<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-195"><a href="#cb31-195" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"GT answer_value:   </span><span class="sc">{</span>row[<span class="ss">f'</span><span class="sc">{</span>gt_answer_col<span class="sc">}</span><span class="ss">_gt'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-196"><a href="#cb31-196" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Pred answer_value: </span><span class="sc">{</span>row[<span class="ss">f'</span><span class="sc">{</span>pred_answer_col<span class="sc">}</span><span class="ss">_pred'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-197"><a href="#cb31-197" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"GT ref_id:         </span><span class="sc">{</span>row[<span class="ss">f'</span><span class="sc">{</span>gt_ref_col<span class="sc">}</span><span class="ss">_gt'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-198"><a href="#cb31-198" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Pred ref_id:       </span><span class="sc">{</span>row[<span class="ss">f'</span><span class="sc">{</span>pred_ref_col<span class="sc">}</span><span class="ss">_pred'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-199"><a href="#cb31-199" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"answer_score: </span><span class="sc">{</span>row[<span class="st">'answer_score'</span>]<span class="sc">:.3f}</span><span class="ss">, "</span></span>
<span id="cb31-200"><a href="#cb31-200" tabindex="-1"></a>                  <span class="ss">f"ref_id_score: </span><span class="sc">{</span>row[<span class="st">'ref_id_score'</span>]<span class="sc">:.3f}</span><span class="ss">, "</span></span>
<span id="cb31-201"><a href="#cb31-201" tabindex="-1"></a>                  <span class="ss">f"is_NA_score: </span><span class="sc">{</span>row[<span class="st">'is_NA_score'</span>]<span class="sc">:.3f}</span><span class="ss">, "</span></span>
<span id="cb31-202"><a href="#cb31-202" tabindex="-1"></a>                  <span class="ss">f"wattbot_score: </span><span class="sc">{</span>row[<span class="st">'wattbot_score'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb31-203"><a href="#cb31-203" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb31-204"><a href="#cb31-204" tabindex="-1"></a>    </span>
<span id="cb31-205"><a href="#cb31-205" tabindex="-1"></a>    <span class="cf">return</span> merged</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>results_df <span class="op">=</span> compute_wattbot_score(</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>    train_qa_path<span class="op">=</span><span class="st">"./data/train_QA.csv"</span>,</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>    preds_path<span class="op">=</span><span class="st">"./data/train_solutions_qwen.csv"</span>,</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>    gt_is_na_col<span class="op">=</span><span class="st">"is_blank"</span>,   <span class="co"># or "is_blank" / None depending on how you mark NAs</span></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>    n_examples<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a>)</span></code></pre>
</div>
</div>
</section><section><h2 class="section-heading" id="recap-and-next-steps">Recap and next steps<a class="anchor" aria-label="anchor" href="#recap-and-next-steps"></a></h2>
<hr class="half-width"><p>In this episode, we:</p>
<ul><li>Loaded a small corpus of AI / ML energy papers into our notebook
environment.</li>
<li>Split long documents into manageable chunks and cached those chunks
to disk so we don’t have to re-run the chunking step every time.</li>
<li>Created vector embeddings for each chunk and used similarity search
to retrieve relevant context for a given question.</li>
<li>Used an LLM to generate answers from retrieved context and wrote
results out to a CSV for later scoring and analysis.</li>
<li>Handled unanswerable questions with an <code>is_blank</code> flag so
the system can explicitly say “I don’t know” when the evidence isn’t
there.</li>
</ul><p>This is just a first pass at a RAG pipeline: it works, but there’s a
lot of headroom to improve both accuracy and robustness. Some natural
next steps:</p>
<ul><li><p><strong>Increase the size/quality of models used for embedding
and generation</strong>: Try stronger embedding models (e.g., larger
sentence-transformers or domain-tuned embeddings) and more capable LLMs
for answer generation, especially if you have GPU budget.</p></li>
<li><p><strong>Add a reranking step</strong>: Instead of sending the
top-k raw nearest neighbors directly to the LLM, use a cross-encoder or
reranker model to re-score those candidates and send only the best
ones.</p></li>
<li>
<p><strong>Handle figures and tables more carefully</strong>: Many
key numbers live in tables, figure captions, or plots. Consider:</p>
<ul><li>OCR / table-parsing tools (e.g., <code>pytesseract</code>, table
extractors, PDF parsers).</li>
<li>Multimodal models that can embed or interpret figures and diagrams,
not just text.</li>
<li>Separate chunking strategies for captions, tables, and main
text.</li>
</ul></li>
<li>
<p><strong>Enrich chunks with metadata</strong>: Attach metadata
like section headings (e.g., <em>Methods</em>, <em>Results</em>), paper
ID, year, or paragraph type. You can:</p>
<ul><li>Filter or boost chunks by metadata at retrieval time.</li>
<li>Use metadata in the prompt so the LLM knows where evidence is coming
from.</li>
</ul></li>
<li>
<p><strong>Look for LLMs tuned for scientific literature</strong>:
Experiment with models that are explicitly trained or finetuned on
scientific text (e.g., arXiv / PubMed) so they:</p>
<ul><li>Parse equations and technical language more reliably.</li>
<li>Are less likely to hallucinate when reading dense scientific
prose.</li>
</ul></li>
</ul><p>As you iterate, the goal is to treat this notebook as a baseline RAG
“workbench”: you can swap in better models, smarter retrieval
strategies, and richer document preprocessing without changing the
overall pipeline structure.</p>
<p>In the next episodes, we will repeat largely the same exact RAG
pipeline using slightly different approaches on AWS (processing jobs and
Bedrock).</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul><li>
<strong>Notebook setup</strong>: Start by provisioning a GPU-backed
notebook instance (e.g., <code>ml.g5.xlarge</code>) so that both the
embedding model and Qwen2.5-7B can run comfortably.</li>
<li>
<strong>Local-first RAG</strong>: For teaching (and small corpora),
we avoid an external vector database and instead perform cosine
similarity search over in-memory embeddings.</li>
<li>
<strong>Ground-truth units</strong>: The <code>answer_unit</code>
column is always copied directly from <code>train_QA.csv</code>, never
guessed by the LLM.</li>
<li>
<strong>Two-stage LLM use</strong>: One call focuses on
<em>answering and citing</em>; a second, lighter call produces a short
explanation tagged with an evidence type.</li>
<li>
<strong>WattBot conventions</strong>: We respect the Kaggle
competition format, using <code>is_blank</code> for unanswerable
questions and for missing fields.</li>
<li>
<strong>Scalability path</strong>: The same logic can later be
swapped to FAISS/Chroma and larger models, while preserving the
interface used here.</li>
</ul></div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"></code></pre>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="00_Overview-RAG-on-AWS.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="02_RAG_WattBot_Processing_Jobs.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="00_Overview-RAG-on-AWS.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Overview of RAG
        </a>
        <a class="chapter-link float-end" href="02_RAG_WattBot_Processing_Jobs.html" rel="next">
          Next: RAG with Processing...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/UW-Madison-DataScience/ml-with-aws-sagemaker/edit/main/episodes/01_RAG_WattBot_GPU-instance.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/UW-Madison-DataScience/ml-with-aws-sagemaker/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/UW-Madison-DataScience/ml-with-aws-sagemaker/" class="external-link">Source</a></p>
        <p>
        <a href="citation.html">Cite</a>
        | <a href="mailto:endemann@wisc.edu">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
		</div>
		<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.17.3" class="external-link">sandpaper (0.17.3)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.9" class="external-link">varnish (1.0.9)</a></p>
		</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://UW-Madison-DataScience.github.io/ml-with-aws-sagemaker/01_RAG_WattBot_GPU-instance.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "AWS, SageMaker, Cloud Computing, Machine Learning, AI",
  "name": "RAG with a Notebook GPU",
  "creativeWorkStatus": "active",
  "url": "https://UW-Madison-DataScience.github.io/ml-with-aws-sagemaker/01_RAG_WattBot_GPU-instance.html",
  "identifier": "https://UW-Madison-DataScience.github.io/ml-with-aws-sagemaker/01_RAG_WattBot_GPU-instance.html",
  "dateCreated": "2024-10-31",
  "dateModified": "2025-12-19",
  "datePublished": "2025-12-19"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

